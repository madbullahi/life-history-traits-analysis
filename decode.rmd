---
title: "Decode Analysis"
output: rmarkdown::github_document
author: "Muhammad Abdullahi"
date: "29/2/2024"
---

***************Load the required libraries***************
*******************************************************


```{r}

library(tidymodels)
library(readxl)
library(rcompanion)
library(lmerTest)
```


***************Load the data***************

```{r}

Data <- read_excel("C:/Users/mxa1132-admin/OneDrive/Documents/life-history-traits-analysis/Decode_Analysis.xlsx") # load the data

```

```{r}
print(Data) # print the data
```

```{r}
summary(Data) # summary of the data
view(Data) # view the data

```

***************Data Preprocessing***************

```{r}
# convert the variables to factors

Data$pop <-  factor(Data$pop, levels = c("P", "E"))
Data$cond <-  factor(Data$cond, levels = c("LA", "HA"))

```


```{r}

colSums(is.na(Data)) # check for missing values

```

```{r}
str(Data) # structure of the data
```
```{r}
Decode_Data <-Data

```


```{r}
Decode_Data$pop <-  factor(Decode_Data$pop, levels = c("P", "E"))
Decode_Data$cond <-  factor(Decode_Data$cond, levels = c("LA", "HA"))
                           
```


```{r}
# select cloumns 5 to 8 

Dacode_Data <- Decode_Data[,c(5:8)]
Dacode_Data
```


```{r}
# remove the missing values

Data_without_NAs <-  Decode_Data[complete.cases(Decode_Data),]
Data_without_NAs

```
```{r}
DD <- Data_without_NAs


```




```{r}
# log transformation of the variables

DD[5:8] <- log(DD[5:8] +0.5)
DD
```
```{r}
log_DD <-  DD[, c(5:8)]

```

```{r}
# run the PCA

PCA1 <- prcomp(log_DD, scale = TRUE)
```

```{r}
# print the PCA results
print(PCA1)
```

```{r}
summary(PCA1)
```

```{r}
#  load the libraries to plot the pca

pop <- as.factor(DD$pop)
cond <-  as.factor(DD$cond)
```


```{r}
p <- fviz_pca_ind(PCA1, habillage = pop, geom = "point") +
  xlim(-4, 4) + ylim(-4, 4) # plot the pca
p
```


```{r}

# save the plot
 ggsave("pca2_plot.png", p, width = 10, height = 10, units = "cm")
```




```{r}
#  check for outliers in the pca

U <-  PCA1$x  # coordinates of individuals
```

```{r}
threshold <- 3 # set the threshold

apply(U, 2, function(x) which(abs(x - mean(x)) > threshold * sd(x)))
```


```{r}

qplot(U[, 1], U[, 2], colour = factor(pop) ) + coord_equal()
```

```{r}
ind.oout <- apply(U, 2, function(x) which(abs(x - mean(x)) > threshold * sd(x))) %>% 
  Reduce(union, .) %>%
  print()# find outliers

```

```{r}
col <- rep("black", nrow(U)); col[ind.oout] <- "red"
qplot(U[, 1], U[, 2], colour = I(col), size = I(2)) + coord_equal()

```
******************Robust PCA******************
1. computes the absolute difference of each column in the matrix U from its median, 
divided by the MAD of that column.
2. calculates a robust covariance distance using the covRob.
****************************************************

```{r}
# robust Mahalanobis distance
dist <- apply(U, 2, function(x) abs(x - median(x)) / mad(x)) %>%  
                apply(1, max) 

dist1 <-  covRob(U, estim = "pairwiseGK")$dist
qqplot(dist, sqrt(dist1))

```


```{r}
# find and print outlier values in each column of the PCA
U_no_outliers <- U
  
outliers <- apply(U, 2, function(x) which( abs(x - mean(x)) > (threshold * sd(x)) )) # find outliers

```





```{r}
for (i in 1:ncol(U)) {  
    U_no_outliers[outliers[[i]], i] <- NA 
  }
```


```{r}
# print the outliers  
U_no_outliers

```


```{r}
# If U_no_outliers has fewer rows, subset Data to match
Data_subset <- Data[1:nrow(U_no_outliers), ]

# Combine the datasets with matching rows
linked_data <- cbind(Data_subset, U_no_outliers)

```

```{r}


view(linked_data) # view the combined data

```


```{r}

original_colnames <- c("sumNeo", "adult", "diff", "size")
```


```{r}
# Rename the columns in the linked dataframe to match the original dataset
colnames(linked_data)[9:12] <- original_colnames

view(linked_data) # view the combined data

```

```{r}

# save the combined data

write.csv(linked_data, "linked_data.csv")

```

```{r}
# nvestigate the outliers using Robust Mahalanobis Distance

dist2 <- covRob

```



```{r}
rpca_result <- PcaCov(U, method = "classic")
```

```{r}

# Identify outliers using a robust method (e.g., based on Mahalanobis distance)
outliers <- boxplot.stats(rpca_result$scores)$out
outliers
```


```{r}

# Create a dataframe with outlier information
outlier_df <- data.frame(
  PC1 = rpca_result$scores[,1],    #  PC1 scores
  PC2 = rpca_result$scores[,2],    #  PC2 scores
  Outlier = ifelse(1:nrow(rpca_result$scores) %in% outliers, "Outlier", "Not Outlier")  #  Outlier status
)
```

```{r}

# Generate an outlier map using ggplot2
library(ggplot2)
ggplot(outlier_df, aes(x = PC1, y = PC2, color = Outlier)) +
  geom_point() +
  labs(title = "Outlier Map based on Robust PCA", x = "PC1", y = "PC2") +
  theme_minimal()

```

