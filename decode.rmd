---
title: "Decode Analysis"
output: rmarkdown::github_document
author: "Muhammad Abdullahi"
date: "29/2/2024"
---

***************Load the required libraries***************
*******************************************************


```{r}

library(tidymodels)
library(readxl)
library(rcompanion)
library(lmerTest)
```


***************Load the data***************

```{r}

Data <- read_excel("C:/Users/mxa1132-admin/OneDrive/Documents/life-history-traits-analysis/Decode_Analysis.xlsx") # load the data

```

```{r}
print(Data) # print the data
```

```{r}
summary(Data) # summary of the data
view(Data) # view the data

```

***************Data Preprocessing***************

```{r}
# convert the variables to factors

Data$pop <-  factor(Data$pop, levels = c("P", "E"))
Data$cond <-  factor(Data$cond, levels = c("LA", "HA"))


```


```{r}

colSums(is.na(Data)) # check for missing values

```

```{r}
str(Data) # structure of the data
```

```{r}
# select cloumns 5 to 8

Data_1 <- Data[,5:8]
Data_1
```

```{r}
# log transformation of the variables

log_Data_1 <- log(Data_1 +0.5)
log_Data_1
```

```{r}
df_with_NANs <-  data.frame(log_Data_1)

```


```{r}
# check for NANs values in each column

nan_columns <-  apply(df_with_NANs, 2, function(x) any(is.nan(x)))  
```

```{r}
#  identify columns with NANs values

columns_with_nans <-  names(nan_columns[nan_columns == TRUE])

columns_with_nans
```

```{r}
# identify rows with NANs values
rows_with_nan <-  which(is.nan(df_with_NANs$diff), arr.ind = TRUE)

rows_with_nan
```


```{r}
# remove NAs or NANs from the data

#log_Data_1 <- log_Data_1[complete.cases(log_Data_1),]

```


```{r}
# run the PCA

pca_Data_1 <- prcomp(log_Data_1, scale = TRUE)
```

```{r}
# print the PCA results
print(pca_Data_1)
```

```{r}
summary(pca_Data_1)
```

```{r}
#  load the libraries to plot the pca

library(FactoMineR)
library(factoextra)
```

```{r}
pca_plot <-  fviz_pca_ind(pca_Data_1, geom.ind = "point", col.ind = Data$pop, pointshape = 19, pointsize = 2, 
                         addEllipses = TRUE, ellipse.level = 0.95, 
                         legend.title = "pop", repel = TRUE)

pca_plot
```


```{r}

# save the plot

ggsave("pca_plot.png", pca_plot, width = 10, height = 10, units = "cm")

```

```{r}
#  check for outliers in the pca

U <-  pca_Data_1$x  # coordinates of individuals
```

```{r}
threshold <- 3 # set the threshold

apply(U, 2, function(x) which(abs(x - mean(x)) > threshold * sd(x)))
```



```{r}
pca_plot2 <- fviz_pca_ind(pca_Data_1, 
                         geom.ind = "point", 
                         col.ind = Data$pop, 
                         pointshape = 19, 
                         pointsize = 2, 
                         addEllipses = TRUE, 
                         ellipse.level = 0.95, 
                         legend.title = "pop", 
                         repel = TRUE,
         
                                      axes = c(2, 3))  # Include PC3 in the plot

pca_plot2
```
```{r}
# find and print outlier values in each column of the PCA
U_no_outliers <- U
  
outliers <- apply(U, 2, function(x) which( abs(x - mean(x)) > (threshold * sd(x)) )) # find outliers
  
  
```

```{r}
for (i in 1:ncol(U)) {  
    U_no_outliers[outliers[[i]], i] <- NA 
  }
```


```{r}
# print the outliers  
U_no_outliers

```


```{r}


linked_data <-  cbind(Data, U_no_outliers) # combine the data with the pca results

```

```{r}


view(linked_data) # view the combined data

```


```{r}

original_colnames <- c("sumNeo", "adult", "diff", "size")
```


```{r}
# Rename the columns in the linked dataframe to match the original dataset
colnames(linked_data)[9:12] <- original_colnames

view(linked_data) # view the combined data

```

```{r}

# save the combined data

write.csv(linked_data, "linked_data.csv")

```
``