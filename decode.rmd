---
title: "Decode Analysis"
output: rmarkdown::github_document
author: "Muhammad Abdullahi"
date: "29/2/2024"
---

***************Load the required libraries***************
*******************************************************


```{r}

library(tidymodels)
library(readxl)
library(rcompanion)
library(lmerTest)
```


***************Load the data***************

```{r}

Data <- read_excel("C:/Users/mxa1132-admin/OneDrive/Documents/life-history-traits-analysis/Decode_Analysis.xlsx") # load the data

```

```{r}
print(Data) # print the data
```

```{r}
summary(Data) # summary of the data
view(Data) # view the data

```

***************Data Preprocessing***************

```{r}
# convert the variables to factors

Data$pop <-  factor(Data$pop, levels = c("P", "E"))
Data$cond <-  factor(Data$cond, levels = c("LA", "HA"))

```


```{r}

colSums(is.na(Data)) # check for missing values

```

```{r}
str(Data) # structure of the data
```
```{r}
Decode_Data <-Data

```


```{r}
Decode_Data$pop <-  factor(Decode_Data$pop, levels = c("P", "E"))
Decode_Data$cond <-  factor(Decode_Data$cond, levels = c("LA", "HA"))
                           
```


```{r}
# select cloumns 5 to 8 

Dacode_Data <- Decode_Data[,c(5:8)]
Dacode_Data
```


```{r}
# remove the missing values

Data_without_NAs <-  Decode_Data[complete.cases(Decode_Data),]
Data_without_NAs

```
```{r}
DD <- Data_without_NAs
```


```{r}
# log transformation of the variables

DD[5:8] <- log(DD[5:8] +0.5)
DD
```
```{r}
log_DD <-  DD[, c(5:8)]

```

```{r}
# run the PCA

PCA1 <- prcomp(log_DD, scale = TRUE)
```

```{r}
# print the PCA results
print(PCA1)
```

```{r}
summary(PCA1)
```

```{r}
#  load the libraries to plot the pca
pop <- as.factor(DD$pop)
cond <-  as.factor(DD$cond)
```


```{r}
p <- fviz_pca_ind(PCA1, habillage = cond, geom = "point",
                  ellipse.level = 0.68,
                  addEllipses = T) +
  xlim(-4, 4) + ylim(-4, 4) # plot the pca
p
```


```{r}

# save the plot
 ggsave("pca2_plot.png", p, width = 10, height = 10, units = "cm")
```




```{r}
#  check for outliers in the pca

U <-  PCA1$x  # coordinates of individuals
```

```{r}
threshold <- 3 # set the threshold

apply(U, 2, function(x) which(abs(x - mean(x)) > threshold * sd(x)))
```


```{r}

qplot(U[, 1], U[, 2], colour = factor(cond) ) + coord_equal()
```

```{r}
ind.oout <- apply(U, 2, function(x) which(abs(x - mean(x)) > threshold * sd(x))) %>% 
  Reduce(union, .) %>%
  print()# find outliers

```

```{r}
col <- rep("black", nrow(U)); col[ind.oout] <- "red"
qplot(U[, 1], U[, 2], colour = I(col), size = I(2)) + coord_equal()
```

******************Robust PCA******************
1. computes the absolute difference of each column in the matrix U from its median, 
divided by the MAD of that column.
2. calculates a robust covariance distance using the covRob.
****************************************************

```{r}
# robust Mahalanobis distance
dist <- apply(U, 2, function(x) abs(x - median(x)) / mad(x)) %>%  
                apply(1, max) 

dist1 <-  covRob(U, estim = "pairwiseGK")$dist
qqplot(dist, sqrt(dist1))

```


```{r}
# extract the pca scores

pca_scores <-  as.data.frame(PCA1$x)
```


```{r}

# Run K-mean clustering on the scores

Kmeans_cluster <-  kmeans(pca_scores, centers = 2)
```

```{r}
#  visualise the clustering results

plot(pca_scores, col = Kmeans_cluster$cluster, pch = 20, cex = 2)

```



```{r}
# find and print outlier values in each column of the PCA
U_no_outliers <- U
  
outliers <- apply(U, 2, function(x) which( abs(x - mean(x)) > (threshold * sd(x)) )) # find outliers

```





```{r}
for (i in 1:ncol(U)) {  
    U_no_outliers[outliers[[i]], i] <- NA 
  }
```


```{r}
# print the outliers  
U_no_outliers

```


```{r}
# If U_no_outliers has fewer rows, subset Data to match
Data_subset <- Data[1:nrow(U_no_outliers), ]

# Combine the datasets with matching rows
linked_data <- cbind(Data_subset, U_no_outliers)

```

```{r}


view(linked_data) # view the combined data

```


```{r}

original_colnames <- c("sumNeo", "adult", "diff", "size")
```


```{r}
# Rename the columns in the linked dataframe to match the original dataset
colnames(linked_data)[9:12] <- original_colnames

view(linked_data) # view the combined data

```

```{r}

# save the combined data

write.csv(linked_data, "linked_data.csv")

```

```{r}

 U_no_outliers


```

```{r}

remove_NAs <- U_no_outliers[complete.cases(U_no_outliers), ]

```


```{r}

apply(U_no_outliers, 2, function(x) which(abs(x - mean(x)) > threshold * sd(x)))

```

```{r}

qplot(U_no_outliers[, 1], U_no_outliers[, 2], colour = factor(cond) ) + coord_equal()

```





```{r}
# function to remove outliers from a specific column.
remove_outliers <- function(column) {
  mean_col <-  mean(column)
  sd_col <-  sd(column)
  outliers_col <- column[abs(column - mean_col) > threshold * sd_col]
  cleaned_column <-  column[!(column %in% outliers_col)]
  return(cleaned_column)
}


```

```{r}
# apply the fuction to each column where you want to removew outliers

cleaned_df <- Data

```


```{r}
# Pad cleaned data to match original dataframe's length
#cleaned_data <- c(remove_outliers(cleaned_df$adult), rep(NA, nrow(cleaned_df) - length(remove_outliers(cleaned_df$adult))))
#cleaned_data <- c(remove_outliers(cleaned_df$diff), rep(NA, nrow(cleaned_df) - length(remove_outliers(cleaned_df$diff))))
#cleaned_data <- c(remove_outliers(cleaned_df$size), rep(NA, nrow(cleaned_df) - length(remove_outliers(cleaned_df$size))))
#cleaned_data <- c(remove_outliers(cleaned_df$sumNeo), rep(NA, nrow(cleaned_df) - length(remove_outliers(cleaned_df$sumNeo))))



# Assign padded data back to the 'adult' column
#cleaned_df$adult <- cleaned_data
#cleaned_df$diff <- cleaned_data
#cleaned_df$size <- cleaned_data
#cleaned_df$sumNeo <- cleaned_data
#cleaned_df


```


```{r}

# import the cleaned excel file
 
clean_raw_data <- read.csv("cleaned_data.csv")
clean_raw_data
view(clean_raw_data)
```

```{r}

# remove NAs from the cleaned data

colSums(is.na(clean_raw_data))
```

```{r}

raw_clean_data <- clean_raw_data[complete.cases(clean_raw_data), ]
raw_clean_data

```

```{r}
log_raw_clean_data <- raw_clean_data
```

```{r}

# log transformation of the variables
log_raw_clean_data[5:8] <-  log(log_raw_clean_data[5:8] + 0.5)
log_raw_clean_data

```

```{r}
# convert the variables to factors

log_raw_clean_data$cond <- factor(log_raw_clean_data$cond, levels = c("AL", "HA"))
log_raw_clean_data$pop <- factor(log_raw_clean_data$pop, levels = c("P", "E"))
```

```{r}
# subset the variables for subsequent analysis

log_subset_data <- log_raw_clean_data[,c(5:8)]
log_subset_data

```

```{r}
# run PCA on the log transformed subsetted data

PCA2 <- prcomp(log_subset_data, scale = TRUE)
print(PCA2)
summary(PCA2)

```

```{r}
# plot the PCA results

pca_plot <- fviz_pca_ind(PCA2, geom.ind = "point", col.ind = log_raw_clean_data$cond, 
                        addEllipses = TRUE, ellipse.level = 0.95, 
                         legend.title = "Condition", repel = TRUE)
pca_plot
```

```{r}
# make a plot of PCA inlcuding the response variables.
respone_biplot <-  fviz_pca_biplot(PCA2,
                                   habillage = raw_clean_data$pop,
                                   palette = c("P" = "red", "E" = "black"),
                                   addEllipses = TRUE,
                                   col.var = "blue",
                                   arrowsize = 0.2,
                                   labelsize = 5,
                                   geom.ind = "point",
                                   pointshape = 19,
                                   pointsize = 3,
                                   mean.point = F,
                                   repel = TRUE,
                                   legend.title = "Population",
                                   ellipse.type = "confidence",
                                   var.scale = 0.5,
                                   xlim = c(-3, 3),
                                   ylim = c(-5, 5),
                                  shape.ind = log_raw_clean_data$cond)

                                   

respone_biplot
```
```{r}
# save the PCA plot

ggsave("PCA_biplot.png", respone_biplot, width = 10, height = 10, units = "in", dpi = 300)

```

```{r}
# calculate the summary statistics for the variable age.
age_summary <- summarySE(raw_clean_data, measurevar = "adult", groupvars = c("cond", "pop"))
age_summary
```

```{r}
# makke a plot of the summary statistics for the variable age.
Age <- ggplot(age_summary,
                        aes(x = cond,
                            y = adult,
                            colour = pop,
                            group = interaction(pop))) +
    geom_errorbar(aes(ymin = adult - se,
                      ymax = adult + se),
                  width = 0.1,
                  position = pd) +
    geom_line(position = pd) +
    theme(panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
          axis.line = element_line(colour = "black"),
          aspect.ratio = 1,
          panel.border = element_rect(colour = "black", fill = NA, size = 0.5)) +
    labs(x = "Treatment",
         y = "Age at Maturity",
         colour = "pop")
Age
```



```{r}



```

