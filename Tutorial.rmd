//  ---
  title: "EDA"
  output: rmarkdown::github_document
  author: "Muhammad"
  date: "10/10/2021"
  ---
  
  #Foundations of Exploratory Data Analysis
  
 "Correlation is a necessary but not a sufficient condition for causation"
  
  # Introduction
  Exploratory Data Analysis (EDA) is an approach to analyzing data sets to summarize their main characteristics, often with visual methods. A statistical model can be used or not, but primarily EDA is for seeing what the data can tell us beyond the formal modeling or hypothesis testing task. Exploratory data analysis was promoted by John Tukey to encourage statisticians to explore the data, and possibly formulate hypotheses that could lead to new data collection and experiments. EDA is different from initial data analysis (IDA), which focuses more narrowly on checking assumptions required for model fitting and hypothesis testing, and handling missing values and making transformations of variables as needed. EDA encompasses IDA.
  
  # Objectives
  The objectives of this tutorial are to:
  
  1. Understand the concept of Exploratory Data Analysis (EDA)
  2. Learn how to import data into R
  3. Learn how to check data structure and summary
  4. Learn how to detect outliers
  5. Learn how to visualize data using boxplots and histograms
  6. Learn how to calculate and summarize statistics
  
  # Data
  The data used in this tutorial is from a study that investigated the effects of microplastics on the life history traits of the freshwater amphipod, Hyalella azteca. The data set contains the following variables:
  
  1. Treatment: Control and PET (polyethylene terephthalate)
  2. Fecundity: Number of offspring produced
  3. Age_maturity: Age at maturity
  4. Size_maturity: Size at maturity
  5. Interval_brood: Interval between broods
  
  # Import Data
  The first step in any data analysis is to import the data into R. The data used in this tutorial is in an Excel file. The readxl package is used to read the Excel file into R. The read_excel() function is used to read the Excel file. The file.choose() function allows you to select the file interactively. Additionally, the sheet argument specifies the sheet name to be read. If the sheet argument is not specified, the first sheet in the Excel file will be read by default. 

```{r}
  # set working directory
  setwd("C:/Users/mxa1132-admin/OneDrive/Documents/life-history-traits-analysis")
```
  
  
  
```{r}
  
  # load libraries
  library(readxl) # for reading excel files, both .xls and .xlsx.
  library(dplyr) # for data manipulation
  library(ggplot2) # for data visualization
  library(lmerTest) # for linear mixed effects models
  library(heplots) # for visualizing linear mixed effects models
  library(rcompanion) # for calculating effect sizes and summarizing statistics.
  
```
  
  # Import Microplastic Data: Tia
```{r}
  # read in data
  Data <- read_excel(file.choose(), sheet = "MP")
  #Data <- read_excel("C:/Users/mxa1132-admin/OneDrive/Documents/life-history-traits-analysis/MP.xlsx", sheet = "MP-Tia")
  
  # the code uses read_excel() function from the readxl package to read an Excel file located in the working directory.
  # the file.choose() function allows you to select the file interactively.
  # Additionally, the sheet argument specifies the sheet name to be read. If the sheet argument is not specified, the first sheet in the Excel file will be read by default.
```
  
  
```{r}
  # check data
  Data
```
  
  
```{r}
  # check data structure
  str(Data) 
  # check data structure e.g array, matrix, data frame, list, factor, character, integer, numeric, logical, etc.
  
  # it provides a summary of the object, including the number of observations, variables, and variable names.
  
```
  
```{r}
  # check data summary
  summary(Data)
  
```
  
```{r}
  # outliers detection
  boxplot(Data$Fecundity, main = "Fecundity", ylab = "fecundity", col = "lightblue", border = "brown", vertical = TRUE) # boxplot for fecundity
  # boxplot () function is used to create boxplots for a given variable.
```
  What does the whiskers represents?
  
```{r}
  # create a boxplot for both control and treatment groups (fecundity))
  
  p <- ggplot(Data, aes(x = Treatment, y = Fecundity, fill = Treatment)) +
   
     geom_boxplot(outlier.colour = "red", outlier.shape = 1, outlier.size = 3) +
    
    labs(x = "Treatment", y = "Fecundity") +
    
    theme_bw() +
    
    theme(legend.position = "none")+
    
    theme(axis.text.x = element_text(angle = 45, hjust = 1))
```
  
```{r}
  print(p)
```
  
 
```{r}
 # Age_maturity 
 # create a boxplot for both control and treatment groups (Age_maturity))
  A <- ggplot(Data, aes(x = Treatment, y = Age_maturity, fill = Treatment)) +
    
    geom_boxplot(outlier.colour = "red", outlier.shape = 1, outlier.size = 3) +
    
    scale_color_manual(values = c("contro" = "red", "PET" = "blue")) +
    
    scale_fill_manual(values = c("control" = "lightblue", "PET" = "lightgreen")) +
    
    theme(legend.key.size = unit(0.5, "cm")) +
    
    labs(x = "Treatment", y = "Age_maturity") +
    
    scale_y_continuous(limits = c(1, 12)) +
    
    theme_minimal() 
    
    #theme(legend.position = "none")+
    
   # theme(axis.text.x = element_text(angle = 45, hjust = 1))
```
  
```{r}
  print(A)
  
```
  
  
  
```{r}
  
  # create a boxplot for both control and treatment groups (Size_maturity))
  
  s <- ggplot(Data, aes(x = Treatment, y = Size_maturity, fill = Treatment)) +
    
    geom_boxplot(outlier.colour = "red", outlier.shape = 1, outlier.size = 3) +
    
    scale_color_manual(values = c("control" = "red", "PET" = "blue")) +
    
    scale_fill_manual(values = c("control" = "lightblue", "PET" = "lightgreen")) +
    
    theme(legend.key.size = unit(0.5, "cm")) +
    
    labs(x = "Treatment", y = "Size_maturity") +
    
    #scale_y_continuous(limits = c(1, 12)) +
    
    theme_minimal() 
    
    #theme(legend.position = "none")+
    
   # theme(axis.text.x = element_text(angle = 45, hjust = 1))
```
  
```{r}
  print(s)
  
```
  
```{r}
  # create a boxplot for both control and treatment groups (interval_broods))
  
  IB <- ggplot(Data, aes(x = Treatment, y = Interval_brood, fill = Treatment)) +
    
    geom_boxplot(outlier.colour = "red", outlier.shape = 1, outlier.size = 3) +
    
    scale_color_manual(values = c("control" = "red", "PET" = "blue")) +
    
    scale_fill_manual(values = c("control" = "lightblue", "PET" = "lightgreen")) +
    
    theme(legend.key.size = unit(0.5, "cm")) +
    
    labs(x = "Treatment", y = "interval_broods") +
    
    #scale_y_continuous(limits = c(1, 12)) +
    
    theme_minimal() 
    
    #theme(legend.position = "none")+
    
   # theme(axis.text.x = element_text(angle = 45, hjust = 1))
```
  
```{r}
  print(IB)
  
```
  
  
```{r}
  # lets use the PCA to fish out the outliers.
  # PCA is a dimensionality reduction technique that is often used to transform a high-dimensional dataset into a smaller-dimensional subspace prior to running a machine learning algorithm on the data.
  
  # PCA is an unsupervised algorithm that learns the principal components of the data.
  
```
  
```{r}
  # PCA: only works with numeric data
  colSums(is.na(Data)) # check for missing values
  
  
```
  
  
```{r}
  D <- Data 
  
  print(D)
```

```{r}
  
  D$Genotypes <- factor(D$Genotypes, levels = c("LRV-0-1", "LR2-36-01")) # convert Genotype to factor.
  
  # Doing this will ensure that Genotype is treated as a categorical variable when we run the PCA.
  
  # by defining the levels, we can control the order in which the levels are plotted.
  
  # it will also help in performing comparisons between the levels of the factor.
  
```
  
```{r}
  D$Treatment <- factor(D$Treatment, levels = c("control", "PET")) # convert Treatment to factor.
```
  
  

```{r}
  D <- D[, c(1,2,3,4,7,10:11)] # select columns 1 to 4, 7, 10 and 11
```
  
```{r}
  D
```
  
```{r}
  comp_D <- D[complete.cases(D),] # remove missing values in rows
  
  # complete.cases() function returns a logical vector indicating which cases are complete, i.e. have no missing values.
  
  # we use this logical vector to subset the data frame and remove the rows with missing values.
  
  # a logical vector is a vector that contains only TRUE and FALSE values or NA values.
  
  # logical vectors are often used to subset data frames.
  
```
  
```{r}
  comp_D
```
  
  
```{r}
  
  comp_D_without_NA <- comp_D
  
  print(comp_D_without_NA)
```
  
  
```{r}
  comp_D_without_NA[4:7] <- log(comp_D_without_NA[4:7] + 0.5) # log transform columns 4 to 7
  
  # takes the natural logarithm of the values in columns 4 to 7 and adds 0.5 to each value before taking the log.
  
  # adding 0.5 to each value ensures that the log is taken for all values, even if the value is 0.
  
  # the addition of 0.5 is a common practice when log transforming count data.
  
```
  
```{r}
  print(comp_D_without_NA) 
```
  
```{r}
  log_comp_D_WO_Na <- comp_D_without_NA[, c(4:7)] # select columns 4 to 7
  
  # Creates a new data frame with only columns 4 to 7.
  
  # we will use this data frame to run the PCA.
  
```
  
```{r}
  
  print(log_comp_D_WO_Na)
```
  
  
```{r}
  # run the PCA with variable scaling on the transformed data
  
  pca <- prcomp(log_comp_D_WO_Na, scale = TRUE) # scale = TRUE scales the variables to have unit variance before running the PCA.
  
  # prcomp() function from stat package returns a list of principal components using the log transformed data. 
  
  # the scale = TRUE argument scales the variables to have unit variance before running the PCA.
  
  # scaling the variables is important because variables with large variances can dominate the PCA.
  
  # scaling the variables ensures that each variable contributes equally to the PCA.
  
  # scaling is important when the variables are measured in different units.
  
  # PCA is sensitive to the scale of the variables.
  
  # the object is stored in the variable pca containing the following components: stdev, rotation,& principal components scores.
  
```
  
```{r}
  # explaining PCA
  
  # the principal components are linear combinations of the original variables.
  
  # each principal component score provides information about the position of the observation in the principal component space.
  
  # these scores are used to understand the relationship between the observations and patterns in the data.
```
  
```{r}
  
  print(pca)
```
  
```{r}
  # what is the relatioship between the socres and variance of the data?
  
  # the principal components are representing the directions of maximum variance in the data.
  
  # Each PC captures a certain amount of variance in the data.
  
  # the first PC captures the most variance, the second PC captures the second most variance, and so on.
  
  # the larger the variance captured by a PC, the more information it contains about the data.
  
  # the Pcs are ordered by the amount of variance they capture.
  
  # this relationship is important in PCA in understanding the contribution of each PC to the data.
```
  
  
```{r}
  # how much variance is captured by each PC?
  
  summary(pca) # the summary() function returns a summary of the PCA.
```
  
  
  
```{r}
  Genotypes <- as.factor(comp_D_without_NA$Genotypes) # convert Genotype to factor
  
```
  
```{r}
  
  Treatment <- as.factor(comp_D_without_NA$Treatment) # convert Treatment to factor
  
```
  

```{r}
  
  # plot the scores for the first two PCs
  
  library(factoextra) # load the factoextra package
  library(FactoMineR) # load the FactoMineR package
  
  
```
  
  
```{r}
  
  
  Pca_plot <- fviz_pca_ind(pca, habillage = Genotypes, geom = "point") # fviz_pca_biplot() function from factoextra package is used to plot the scores for the first two PCs.
```

```{r}
  
  
print(Pca_plot)
  
```
  
```{r}
  
  fviz_pca_biplot(pca,
               col.ind = Genotypes, # color by Genotype
              palette = c("LRV-0-1"="red","LR2-36-01"="black"), # color palette
                addEllipses = TRUE, # Concentration ellipses
                col.var="blue", # Variables color
                arrowsize=0.2, # Arrow size
               labelsize=3, # Label size
               geom.ind = "point", # show points only (nbut not "text")
               pointsize=1, # Point size
               pointshape=19, # Point shape
               mean.point=F,# Show mean point
              # xlim=c(-5,5),# x axis limits
               #ylim=c(-3,3), # y axis limits
               var.scale=0.5, # Scaling of the variables
               ellipse.type = "confidence", # Confidence ellipse
               legend.title = "Genotype", # Legend title
               repel = TRUE, # Avoid text overlapping
               )
  
```
  
  
```{r}
  
  U <- pca$x
  
  print(U)
```
  
```{r}
  qplot(U[, 1], U[, 2], colour = factor(Treatment) ) + coord_equal() # plot the first two PCs
```
  
```{r}
  #Measuring Outliers
  apply(U, 2, function(x) which( abs(x - mean(x)) > (2 * sd(x)) )) # find outliers
  
  # applies a function to each column of the matrix U.
  
  # the function finds the observations that are more than 3 standard deviations from the mean.
  
  # '2' indicates that the function is applied to each column of the matrix U.
  
  # which() function is used to identify the indices that satisfy the condition.
```
  
```{r}
  apply(U, 2, function(x) which( abs(x - mean(x)) > (3 * sd(x)) )) # find outliers
```
  
```{r}
  
  # Three standard deviations away from the mean is a statistical concept related to the spread of data in a normal distribution. 
  
  # In a normal distribution, 99.7% of the data is within three standard deviations of the mean.
  
  # The observations that are more than three standard deviations away from the mean are considered outliers.
  
  # the observations that are more than three standard deviations away from the mean are considered outliers.
  
  # the observations that are more than two standard deviations away from the mean are considered extreme values.
```
  
```{r}
  # Tukeys method
  
  # Tukey's method is a statistical method for identifying outliers.
  
  # Tukey's method uses the interquartile range (IQR) to identify outliers.
  
  
```
  
```{r}
  
  #U_no_outliers <- U
  
  #outliers <- apply(U, 2, function(x) which( abs(x - mean(x)) > (3 * sd(x)) )) # find outliers
  
  #for (i in 1:ncol(U)) {
   # U_no_outliers[outliers[, i], i] <- NA
  #}
```
  
```{r}
  
  #for (i in 1:ncol(U)) {
   # U_no_outliers[outliers[[i]], i] <- NA
  #}
```
  
```{r}
  #U_no_outliers 
  
```
  
```{r}
  
  #qplot(U_no_outliers[, 1], U_no_outliers[, 2], colour = factor(Genotype) ) + coord_equal()
```
  
  
```{r}
  # plot the reaction norms for the variables in the data
  
  # prepapre a summary statistics for the variables in the data
  
```
  
  
```{r}
  .
  
  print(comp_D)
```
  
```{r}
  
  # load the package for the summary statistics
  
  library(Rmisc) # load the Rmisc package
```
  
```{r}
  # summary statistics for the vairable Age at maturity
  
  Age_at_maturity <- summarySE(comp_D, measurevar = "Age_maturity", groupvars = c("Genotypes", "Treatment"))
  
```
  


```{r}
  
  print(Age_at_maturity)
```
  
  
```{r}
  # plot the reacton norm for Age at maturity
  
  pd = position_dodge(0.1) # position_dodge() function from ggplot2 package is used to position the bars side by side.
  
  Age <- ggplot(Age_at_maturity,
                aes(x = Treatment, # aes() function from ggplot2 package is used to specify the variables to be plotted.
                    y = Age_maturity, 
                    colour = Genotypes,
                    group = interaction(Genotypes))) +
    geom_errorbar(aes(ymin = Age_maturity - se, # geom_errorbar() function from ggplot2 package is used to plot the error bars.
                      ymax = Age_maturity + se),
                  width = 0.1, # width of the error bars
                  position = pd) +
    geom_line(position = pd) + # geom_line() function from ggplot2 package is used to plot the lines.
    theme(panel.grid.major = element_blank(), # theme() function from ggplot2 package is used to remove the grid lines.
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
          axis.line = element_line(colour = "black")) +
    labs(x = "Treatment", # labs() function from ggplot2 package is used to add labels to the plot.
         y = "Age at maturity",
         colour = "Genotype") +
    #xlim(c(0.5, 2.5)) # xlim() function from ggplot2 package is used to set the limits for the x axis.
  ylim(c(2, 10)) # ylim() function from ggplot2 package is used to set the limits for the y axis.
    
  
```
  
  
```{r}
  print(Age)
```
  
  
```{r}
  # summary statistics for the variable Size at maturity.
  
  Size_at_maturity <- summarySE(comp_D, measurevar = "Size_maturity", # summarySE() function from Rmisc package is used to calculate the summary statistics.
                                groupvars = c("Genotypes", "Treatment")) # measurevar argument is used to specify the variable for which the summary statistics are calculated.
  # groupvars argument is used to specify the variables for which the summary statistics are calculated.
  
```
  
```{r}
  print(Size_at_maturity)
```
  
```{r}
  Size <- ggplot(Size_at_maturity,
                 aes(x = Treatment,
                     y = Size_maturity,
                     colour = Genotypes,
                     group = interaction(Genotypes))) +
    geom_errorbar(aes(ymin = Size_maturity - se,
                      ymax = Size_maturity + se),
                  width = 0.1,
                  position = pd) +
    geom_line(position = pd) +
    theme(panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
          axis.line = element_line(colour = "black")) +
    labs(x = "Treatment",
         y = "Size at maturity",
         colour = "Genotype") #+
    #xlim(c(0.5, 2.5))
```
  
```{r}
  
  print(Size)
```
  
```{r}
  # summary statistics for the variable Fecundity
  
  fecundity <- summarySE(comp_D, measurevar = "Fecundity", groupvars = c("Genotypes", "Treatment"))
  
```
  
```{r}
  print(fecundity)
```
  
```{r}
  # plot the reaction norm for fecundity
  FecunDity <- ggplot(fecundity,
                      aes(x = Treatment,
                          y = Fecundity,
                          colour = Genotypes,
                          group = interaction(Genotypes))) +
    geom_errorbar(aes(ymin = Fecundity - se,
                      ymax = Fecundity + se),
                  width = 0.1,
                  position = pd) +
    geom_line(position = pd) +
    theme(panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
          axis.line = element_line(colour = "black")) +
    labs(x = "Treatment",
         y = "Fecundity",
         colour = "Genotype") #+
    #xlim(c(0.5, 2.5))
```
  
```{r}
  print(FecunDity)
```
  
```{r}
  # summary statistics for the variable Intervarl between broods
  
  IN_BRD <- summarySE(comp_D, measurevar = "Interval_brood", groupvars = c("Genotypes", "Treatment"))
  
```
  
```{r} 
  print(IN_BRD)
```
  
```{r}
  # plot the reaction norm for Interval between broods
  Interval_between_broods <- ggplot(IN_BRD,
                                    aes(x = Treatment,
                                        y = Interval_brood,
                                        colour = Genotypes,
                                        group = interaction(Genotypes))) +
    geom_errorbar(aes(ymin = Interval_brood - se,
                      ymax = Interval_brood + se),
                  width = 0.1,
                  position = pd) +
    geom_line(position = pd) +
    theme(panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
          axis.line = element_line(colour = "black")) +
    labs(x = "Treatment",
         y = "Interval between broods",
         colour = "Genotype") +
    ylim(c(0.5, 5.0))
```
  
```{r}
  print(Interval_between_broods)
```
  
```{r}
  # Analysis of variance (ANOVA) for the variable Age at maturity
  
  Age_maturity <- comp_D[, 'Age_maturity'] # extract the variable Age at maturity from the data frame comp_D
  
  Genotypes <- comp_D[, 'Genotypes'] # extract the variable Genotypes from the data frame comp_D
  
  Treatment <- comp_D[, 'Treatment'] # extract the variable Treatment from the data frame comp_D
  
  
```
  
```{r}
  # load the required packages for ANOVA
  
  library(lmerTest) # lmerTest package is used to perform the ANOVA
  
```
  
  #Analysis of Deviance vs Analysis of Variance:
  
  #Analysis of Deviance is used to compare the models with different fixed effects.
  
  #Analysis of Variance is used to compare the models with different random effects.
  
```{r}
  # perform the ANOVA
  
  Age_maturity_ANOVA <- lmer(Age_maturity ~ Treatment*Genotypes + (1|Genotypes: Replicates), data = comp_D) 
  
  # lmer() function from lmerTest package is used to perform the ANOVA.
  # Age_maturity ~ Treatment*Genotypes + (1|Genotypes: Replicates) is the formula for the ANOVA.
  # Treatment*Genotypes is the fixed effect.
  # (1|Genotypes: Replicates) is the random effect.
```
  
```{r}
  # print the ANOVA results
  
  anova(Age_maturity_ANOVA)
```
  
```{r}
  
  # Analysis of variance (ANOVA) for the variable Size at maturity
  
  Size_maturity <- comp_D[, 'Size_maturity'] # extract the variable Size at maturity from the data frame comp_D
```
  
```{r}
  
  # perform the ANOVA
  
  Size_maturity_ANOVA <- lmer(Size_maturity ~ Treatment*Genotypes + (1|Genotypes: Replicates), data = comp_D)
```
  
```{r}
  
  anova(Size_maturity_ANOVA)
```
  
```{r}
  # Analysis of variance (ANOVA) for the variable Fecundity
  
  Fecundity <- comp_D[, 'Fecundity'] # extract the variable Fecundity from the data frame comp_D
```
  
```{r}
  # perform the ANOVA
  
  fecundity_ANOVA <- lmer(Fecundity ~ Treatment*Genotypes + (1|Genotypes: Replicates), data = comp_D)
```
  
```{r}
  # print the ANOVA results
  
  anova(fecundity_ANOVA) # print the ANOVA results
```
  
```{r}
  
  # Analysis of variance (ANOVA) for the variable Interval between broods
  
  Interval_brood <- comp_D[, 'Interval_brood'] # extract the variable Interval between broods from the data frame comp_D
```
  
```{r}
  # perform the ANOVA
  
  Interval_brood_ANOVA <- lmer(Interval_brood ~ Treatment*Genotypes + (1|Genotypes: Replicates), data = comp_D)
```
  
```{r}
  # print the ANOVA results
  
  anova(Interval_brood_ANOVA) # print the ANOVA results
```

```{r}
  
  summary(Age_maturity_ANOVA) # print the summary of the ANOVA results
```

```{r}
  # check if the data is normally distributed and meets the assumptions of ANOVA
  
  # check the normality of the data
  
  
```
  
```{r}
  # check the normality of the variable Age at maturity
  # plot the histogram of the residuals of the variable 'Age at maturity'
  
  x <- residuals(Age_maturity_ANOVA) # extract the residuals of the variable 'Age at maturity' from the ANOVA results
  
```
  
```{r}
  
  plotNormalHistogram(x) # plot the histogram of the residuals of the variable 'Age at maturity'
```
  
```{r}
  # plot the qq-plot of the residuals of the variable 'Age at maturity'
  
  qqnorm(residuals(Age_maturity_ANOVA),
         ylab = "Sample Quantiles for Residuals") # plot the qq-plot of the residuals of the variable 'Age at maturity'
  
  qqline(residuals(Age_maturity_ANOVA),
         col = "red") # add the reference line to the qq-plot
```
  
```{r}
  # how the qq-plot should look like if the data is normally distributed;
  # the points should be on the reference line. Deviations from the reference line indicate that the data is not normally distributed.
  # edge effects are common in the qq-plot. if the edge effects are present, the data is not normally distributed.it suggests that the tails of the residuals are not normally distributed.
  # the qq-plot compares the quantiles of the residuals to the quantiles of the theoretical normal distribution.
  # what are  residuals? they are used to assess the goodness of fit of a model. 
```
  
```{r}
  # check the normality of the variable Size at maturity
  
  s <- residuals(Size_maturity_ANOVA) # extract the residuals of the variable 'Size at maturity' from the ANOVA results
  
```
  
```{r}
  # plot the histogram of the residuals of the variable 'Size at maturity'
  
  plotNormalHistogram(s) # plot the histogram of the residuals of the variable 'Size at maturity'
```
  
```{r}
  # plot the qq-plot of the residuals of the variable 'Size at maturity'
  
  qqnorm(residuals(Size_maturity_ANOVA),
         ylab = "Sample Quantiles for Residuals") # plot the qq-plot of the residuals of the variable 'Size at maturity'
  
  qqline(residuals(Size_maturity_ANOVA),
         col = "red") # add the reference line to the qq-plot
```
  
```{r}
  # check the normality of the variable Fecundity
  
  f <- residuals(fecundity_ANOVA) # extract the residuals of the variable 'Fecundity' from the ANOVA results
  
```
  
```{r}
  # plot the histogram of the residuals of the variable 'Fecundity'
  
  plotNormalHistogram(f) # plot the histogram of the residuals of the variable 'Fecundity'
```
  
```{r}
  # plot the qq-plot of the residuals of the variable 'Fecundity'
  
  qqnorm(residuals(fecundity_ANOVA),
         ylab = "Sample Quantiles for Residuals") # plot the qq-plot of the residuals of the variable 'Fecundity'
  qqline(residuals(fecundity_ANOVA),
         col = "red") # add the reference line to the qq-plot
```
  
```{r}
  # check the normality of the variable Interval between broods
    
  i <- residuals(Interval_brood_ANOVA) # extract the residuals of the variable 'Interval between broods' from the ANOVA results
  
```
  
```{r}
  # plot the histogram of the residuals of the variable 'Interval between broods'
  
  plotNormalHistogram(i) # plot the histogram of the residuals of the variable 'Interval between broods'
```
  
```{r}
  # plot the qq-plot of the residuals of the variable 'Interval between broods'
  
  qqnorm(residuals(Interval_brood_ANOVA),
         ylab = "Sample Quantiles for Residuals") # plot the qq-plot of the residuals of the variable 'Interval between broods'
  qqline(residuals(Interval_brood_ANOVA),
         col = "red") # add the reference line to the qq-plot
```
  
```{r}
  # Run an ANOV with the log transformed data
  
  print(comp_D_without_NA) # print the data frame comp_D_without_NA
  
```
  
```{r}
  
  # subset the variable Age at maturity
  
  Age_maturity <- comp_D_without_NA[, 'Age_maturity'] # extract the variable Age at maturity from the data frame comp_D_without_NA
  
  #print(Age_at_maturity_log) # print the variable Age at maturity
  
```
  
```{r}
  print(Age_maturity) # print the variable Age at maturity
```
  
  
```{r}
  # run the ANOV with the log transformed data for Age at maturity
  
  Age_maturity_log_ANOVA <- lmer(Age_maturity ~ Treatment*Genotypes + (1|Genotypes: Replicates), data = comp_D_without_NA)
```
  
```{r}
  anova(Age_maturity_log_ANOVA) # print the ANOVA results
```
  
```{r}
  # check the normality of the variable Age at maturity
  
  a <- residuals(Age_maturity_log_ANOVA) # extract the residuals of the variable 'Age at maturity' from the ANOVA results
  
```
  
```{r}
  plotNormalHistogram(a) # plot the histogram of the residuals of the variable 'Age at maturity'
```
  
```{r}
  # plot the qq-plot of the residuals of the variable 'Age at maturity'
  
  qqnorm(residuals(Age_maturity_log_ANOVA),
         ylab = "Sample Quantiles for Residuals") # plot the qq-plot of the residuals of the variable 'Age at maturity'
  qqline(residuals(Age_maturity_log_ANOVA),
         col = "red") # add the reference line to the qq-plot
```
  The assumption of linear models are about the residuals, not the raw data. The residuals are the difference between the observed values and the fitted values. The residuals are the errors of the model. The residuals are the
  
  
  
  # PFOS data: Tia
```{r}
  # Import the PFOS data.
  PFOs_data <- read_excel(file.choose(), sheet = "PFOS-Tia") # import the PFOS data
  
```
  
```{r}
  print(PFOs_data) # print the PFOS data
```
  
```{r}
  summary(PFOs_data) # print the summary of the PFOS data
```
  
```{r}
  str(PFOs_data) # plot the Boxplot of the PFOS data
```
  
  
```{r}
  #check for complete cases
  
  colSums(is.na(PFOs_data)) # check for complete cases
```
  
```{r}
  
  PFOS_DT <- PFOs_data[complete.cases(PFOs_data),] # remove the missing values from the PFOS data
  
```
  
```{r}
  print(PFOS_DT) # print the PFOS data
```
  
```{r}
  PFOS_without_NA <- PFOS_DT
```
  
```{r}
  # Conert the Gentoypes $ Treatment to factors
  
  
  Genotypes <- as.factor(PFOS_without_NA$Genotypes) # convert the Genotypes to factors
  
  Treatment <- as.factor(PFOS_without_NA$Treatment) # convert the Treatment to factors
  
```
  
```{r}
  # subset the need variables to create a new dataframe
  
  PFOS_Data_new <- PFOS_without_NA[, c("Replicates","Genotypes", "Treatment", "Size_maturity", "Fecundity", "Interval_brood", "Age_maturity")] # subset the need variables to create a new dataframe
  
```
  
```{r}
  print(PFOS_Data_new) # print the new dataframe
```
  
```{r}
  # log transform the variables Size at maturity, Fecundity, Ages_maturity and Interval between broods.
  
  PFOS_Data_new_log <- log(PFOS_Data_new[, c("Size_maturity", "Fecundity", "Interval_brood", "Age_maturity")] + 0.5) # log transform the variables Size at maturity, Fecundity, Ages_maturity and Interval between broods.
  
```
  
```{r}
  print(PFOS_Data_new_log) # print the log transformed data
```
  
```{r}
  # perform a PCA on the log transformed data.
  
  PFOS_PCA <- prcomp(PFOS_Data_new_log, center = TRUE, scale. = TRUE) # perform a PCA on the log transformed data.
  
```
  
```{r}
  
  summary(PFOS_PCA) # print the summary of the PCA
```
  
```{r}
  print(PFOS_PCA) # print the PCA
```
  
```{r}
  
  Genotypes <- as.factor(PFOS_Data_new$Genotypes) # convert the Genotypes to factors
  Treatment <- as.factor(PFOS_Data_new$Treatment) # convert the Treatment to factors
```
  
  
  
  
```{r}
  PFOS_pca_plot <- fviz_pca_ind(PFOS_PCA, habillage = Genotypes, geom = "point") # plot the PCA
```
  
  
```{r}
  print(PFOS_pca_plot) # print the PCA
```

```{r}
  fviz_pca_biplot(PFOS_PCA, # plot the PCA
               col.ind = Genotypes, # color by Genotype
              palette = c("LRV-0-1"="red","LR2-36-01"="black"), # color palette
                addEllipses = TRUE, # Concentration ellipses
                col.var="blue", # Variables color
                arrowsize=0.2, # Arrow size
               labelsize=3, # Label size
               geom.ind = "point", # show points only (nbut not "text")
               pointsize=1, # Point size
               pointshape=19, # Point shape
               mean.point=F,# Show mean point
              # xlim=c(-5,5),# x axis limits
               #ylim=c(-3,3), # y axis limits
               var.scale=0.5, # Scaling of the variables
               ellipse.type = "confidence", # Confidence ellipse
               legend.title = "Genotype", # Legend title
               repel = TRUE, # Avoid text overlapping
               )
```
  
  
```{r}
  U2 <- PFOS_PCA$x # extract the second column of the rotation matrix
```
  
```{r}
  U2
```
  
```{r}
  qplot(U2[, 1], U2[, 2], colour = factor(Treatment) ) + coord_equal() # plot the first two PC
```
  
```{r}
  # look for potential ouliers in the PFOS data
  
  apply(U2, 2, function(x) which( abs(x - mean(x)) > (2 * sd(x)) )) # look for potential ouliers in the PFOS data
  
  apply(U2, 2, function(x) which( abs(x - mean(x)) > (3 * sd(x)) )) # look for potential ouliers in the PFOS data
```
  
```{r}
  # summary stats for Age at maturity from the PFOS data.
  
  Age_AT_Maturity <- summarySE(PFOS_Data_new, measurevar = "Age_maturity", groupvars = c("Genotypes", "Treatment")) # summary stats for Age at maturity from the PFOS data.
  
```
  
```{r}
  print(Age_AT_Maturity) # print the summary stats for Age at maturity from the PFOS data.
```
  
  
  
```{r}
  # Plot the reaction norm for Age at Maturity
  
  Age_PFOs <- ggplot(Age_AT_Maturity,
                                    aes(x = Treatment,
                                        y = Age_maturity,
                                        colour = Genotypes,
                                        group = interaction(Genotypes))) +
    geom_errorbar(aes(ymin = Age_maturity - se,
                      ymax = Age_maturity + se),
                  width = 0.1,
                  position = pd) +
    geom_line(position = pd) +
    theme(panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
          axis.line = element_line(colour = "black")) +
    labs(x = "Treatment",
         y = "Age at Maturity",
         colour = "Genotype")
    
```
  
```{r}
  
  print(Age_PFOs) # print the reaction nomr for Age at Maturity
  
```
  
```{r}
  # summary stats for Size at maturity from the PFOS data.
  
  Size_pfos <- summarySE(PFOS_Data_new, measurevar = "Size_maturity", groupvars = c("Genotypes", "Treatment")) # summary stats for Size at maturity from the PFOS data.
  
```
  
```{r}
  print(Size_pfos) # print the summary stats for Size at maturity from the PFOS data.
  
  
```
  
  
```{r}
  # plot the reaction norm for Size at maturity.
  
  Size_PFOs <- ggplot(Size_pfos,
                                    aes(x = Treatment,
                                        y = Size_maturity,
                                        colour = Genotypes,
                                        group = interaction(Genotypes))) +
    geom_errorbar(aes(ymin = Size_maturity - se,
                      ymax = Size_maturity + se),
                  width = 0.1,
                  position = pd) +
    geom_line(position = pd) +
    theme(panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
          axis.line = element_line(colour = "black")) +
    labs(x = "Treatment",
         y = "Size at Maturity",
         colour = "Genotype")
    
```
  
```{r}
  
  print(Size_PFOs) # print the reaction nomr for Size at maturity.
  
  
```
  
```{r}
  # plot the reaction norm for Fecundity.
  
  fecundity_pfos <- summarySE(PFOS_Data_new, measurevar = "Fecundity", groupvars = c("Genotypes", "Treatment")) # summary stats for Fecundity from the PFOS data.
  
```
  
```{r}
  print(fecundity_pfos) # print the summary stats for Fecundity from the PFOS data.
  
  
```
  
```{r}
  # plot the reaction norm for Fecundity.
  
  fecundity_pfos <- ggplot(fecundity_pfos,
                                    aes(x = Treatment,
                                        y = Fecundity,
                                        colour = Genotypes,
                                        group = interaction(Genotypes))) +
    geom_errorbar(aes(ymin = Fecundity - se,
                      ymax = Fecundity + se),
                  width = 0.1,
                  position = pd) +
    geom_line(position = pd) +
    theme(panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
          axis.line = element_line(colour = "black")) +
    labs(x = "Treatment",
         y = "Fecundity",
         colour = "Genotype")
    
```
  
```{r}
  print(fecundity_pfos) # print the reaction nomr for Fecundity.
```
  
```{r}
  # perform the summary stats for interval between brood events from the PFOS data.
  
  IB_pfos <- summarySE(PFOS_Data_new, measurevar = "Interval_brood", groupvars = c("Genotypes", "Treatment")) # summary stats for interval between brood events from the PFOS data.
  
```
  
```{r}
  print(IB_pfos) # print the summary stats for interval between brood events from the PFOS data.
  
```
  
```{r}
  
  # plot the reaction norm for interval between brood events.
  
  IB_PFos <- ggplot(IB_pfos,
                                    aes(x = Treatment,
                                        y = Interval_brood,
                                        colour = Genotypes,
                                        group = interaction(Genotypes))) +
    geom_errorbar(aes(ymin = Interval_brood - se,
                      ymax = Interval_brood + se),
                  width = 0.1,
                  position = pd) +
    geom_line(position = pd) +
    theme(panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
          axis.line = element_line(colour = "black")) +
    labs(x = "Treatment",
         y = "Interval between brood events",
         colour = "Genotype")
    
```
  
```{r}
  print(IB_PFos) # print the reaction nomr for interval between brood events.
```


```{r}
  # subset the variables from the original data set for the PFOS data.
  
  PFOS_Data2 <- PFOs_data[, c("Replicates", "Genotypes", "Treatment", "Age_maturity", "Size_maturity", "Fecundity", "Interval_brood")]
  
```
  
```{r}
  print(PFOS_Data2) # print the subsetted data for the PFOS data.
  
```
  
```{r}
  
  
  # subset the variables  (response and fixed) from the original data set for the PFOS data.
  
  Age_maturity <- PFOS_Data2[, "Age_maturity"]
  
  Genotypes <- PFOS_Data2[, "Genotypes"]
  
  Treatment <- PFOS_Data2[, "Treatment"]
```
  
```{r}
  # perform the Anova for the variable Age at maturity from the PFOS data.
  
  Age_maturity_Ano <- lmer(Age_maturity ~ Treatment * Genotypes + (1|Genotypes: Replicates), data = PFOS_Data2)
  
```
  
```{r}

  anova(Age_maturity_Ano) # print the Anova for the variable Age at maturity from the PFOS data.
  
```
  
  
  
  
  
  
  
  
  # PFOA data : Tia
```{r}
  # import PFOA data
  
  PFOA_Data <- read_excel(file.choose(), sheet = "PFOA-Tia")
  
```
  
  
```{r}
  print(PFOA_Data) # print the PFOA data
  
```
  
  
```{r}
  colSums(is.na(PFOA_Data)) # check for missing values
  
```
  
```{r}
  PFOA_without_NA <- PFOA_Data[complete.cases(PFOA_Data),] # remove missing values
  
  
  print(PFOA_without_NA) # print the PFOA data without missing values
  
```
  
  
```{r}
  # subset the required variables from the PFOA data
  
  PFOA_Data_new <- PFOA_without_NA[, c("Replicates", "Genotypes", "Treatment", "Age_maturity", "Size_maturity", "Fecundity", "Invterval_brood")]
  
```
  
```{r}
  
  print(PFOA_Data_new) # print the subsetted PFOA data
  
```
  
  
```{r}
  # log transform the variables from the PFOA data
  
  PFOA_log_data <- log(PFOA_Data_new[, c("Age_maturity", "Size_maturity", "Fecundity", "Invterval_brood")])
  
  
```
  
  
```{r}
  print(PFOA_log_data) # print the log transformed data.
  
```
  
```{r}
  # convert the variables Genotypes and Treatment as factors.
  
  Genotypes <- as.factor(PFOA_Data_new$Genotypes) # convert the genotypes as factors .
  
  Treatment <- as.factor(PFOA_Data_new$Treatment) # convert Treatment as factors.
  
```
  
  
  
  
```{r}
  # perform the pca for the log transformed data.
  
  
  PFOA_pca <- prcomp(PFOA_log_data, center = TRUE, scale. = TRUE)
  
  print(PFOA_pca) # print the pca for the log transformed data.
  
```
  
```{r}
  
  summary(PFOA_pca) # summary of the pca for the log transformed data.
  
```
  
```{r}
  # plot the pca for the log transformed data.
  
  PFOA_pca_plot <- fviz_pca_biplot(PFOA_pca, geom = "point", habillage = Treatment)
```
  
```{r}
  print(PFOA_pca_plot) # print the pca for the log transformed data.
  
```
  
```{r}
  # pca biplot
  
  fviz_pca_biplot(PFOA_pca, # plot the PCA
               col.ind = Genotypes, # color by Genotype
              palette = c("LRV-0-1"="red","LR2-36-01"="black"), # color palette
                addEllipses = TRUE, # Concentration ellipses
                col.var="blue", # Variables color
                arrowsize=0.2, # Arrow size
               labelsize=3, # Label size
               geom.ind = "point", # show points only (nbut not "text")
               pointsize=1, # Point size
               pointshape=19, # Point shape
               mean.point=F,# Show mean point
              # xlim=c(-5,5),# x axis limits
               #ylim=c(-3,3), # y axis limits
               var.scale=0.5, # Scaling of the variables
               ellipse.type = "confidence", # Confidence ellipse
               legend.title = "Genotype", # Legend title
               repel = TRUE, # Avoid text overlapping
               )
```
  
```{r}
  
  # summary stats for Age at maturity from the PFOA data.
  
  Age_pfoa <- summarySE(PFOA_Data_new, measurevar = "Age_maturity", groupvars = c("Treatment", "Genotypes"))
  
  print(Age_pfoa) # print the summary stats for Age at maturity from the PFOA data.
  
```
  
```{r}
  
  # plot the reaction norm for Age at maturity from the PFOA data.
  
  Age_pfoa_plot <- ggplot(Age_pfoa,
                                    aes(x = Treatment,
                                        y = Age_maturity,
                                        colour = Genotypes,
                                        group = interaction(Genotypes))) +
    geom_errorbar(aes(ymin = Age_maturity - se,
                      ymax = Age_maturity + se),
                  width = 0.1,
                  position = pd) +
    geom_line(position = pd) +
    theme(panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
          axis.line = element_line(colour = "black")) +
    labs(x = "Treatment",
         y = "Age at maturity",
         colour = "Genotype")
    
  
  print(Age_pfoa_plot) # print the plot for the reaction norm for Age at maturity from the PFOA data.
  
```
  
```{r}
  # summary stats for Size at maturity from the PFOA data.
  
  Size_pfoa <- summarySE(PFOA_Data_new, measurevar = "Size_maturity", groupvars = c("Treatment", "Genotypes"))
  
  print(Size_pfoa) # print the summary stats for Size at maturity from the PFOA data.
  
```
  
```{r}
  # plot the reaction norm for Size at maturity from the PFOA data.
  
  size_pfoa_plot <- ggplot(Size_pfoa,
                                    aes(x = Treatment,
                                        y = Size_maturity,
                                        colour = Genotypes,
                                        group = interaction(Genotypes))) +
    geom_errorbar(aes(ymin = Size_maturity - se,
                      ymax = Size_maturity + se),
                  width = 0.1,
                  position = pd) +
    geom_line(position = pd) +
    theme(panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
          axis.line = element_line(colour = "black")) +
    labs(x = "Treatment",
         y = "Size at maturity",
         colour = "Genotype")
  
  print(size_pfoa_plot) # print the plot for the reaction norm for Size at maturity from the PFOA data.
```
  
```{r}
  # summary stats for Fecundity from the PFOA data.
  
  fecundity_pfoa <- summarySE(PFOA_Data_new, measurevar = "Fecundity", groupvars = c("Treatment", "Genotypes"))
  
  print(fecundity_pfoa) # print the summary stats for Fecundity from the PFOA data.
  
```
  
```{r}
  # plot the reaction norm for Fecundity from the PFOA data.
  
  fecundity_pfoa_plot <- ggplot(fecundity_pfoa,
                                    aes(x = Treatment,
                                        y = Fecundity,
                                        colour = Genotypes,
                                        group = interaction(Genotypes))) +


        geom_errorbar(aes(ymin = Fecundity - se,
                      ymax = Fecundity + se),
                  width = 0.1,
                  position = pd) +
    geom_line(position = pd) +
    theme(panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
          axis.line = element_line(colour = "black")) +
    labs(x = "Treatment",
         y = "Fecundity",
         colour = "Genotype")
  
  print(fecundity_pfoa_plot) # print the plot for the reaction norm for Fecundity from the PFOA data.
```
  
```{r}
  # summary stats for interval between broods from the PFOA data.
  
  interval_pfoa <- summarySE(PFOA_Data_new, measurevar = "Invterval_brood", groupvars = c("Treatment", "Genotypes"))
  
  print(interval_pfoa) # print the summary stats for interval between broods from the PFOA data.
  
```
  
```{r}
  # plot the reaction norm for interval between broods from the PFOA data.
  
  interval_pfoa_plot <- ggplot(interval_pfoa,
                                    aes(x = Treatment,
                                        y = Invterval_brood,
                                        colour = Genotypes,
                                        group = interaction(Genotypes))) +
    geom_errorbar(aes(ymin = Invterval_brood - se,
                      ymax = Invterval_brood + se),
                  width = 0.1,
                  position = pd) +
    geom_line(position = pd) +
    theme(panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
          axis.line = element_line(colour = "black")) +
    labs(x = "Treatment",
         y = "Interval between broods",
         colour = "Genotype")
  
  print(interval_pfoa_plot) # print the plot for the reaction norm for interval between broods from the PFOA data.
```
  
```{r}
  
  # perform the ANOVA for Age at maturity from the PFOA data.
  
  Age_pfoa_ano <- lmer(Age_maturity ~ Treatment * Genotypes + (1|Genotypes: Replicates), data = PFOA_Data_new)
  
  anova(Age_pfoa_ano) # print the ANOVA for Age at maturity from the PFOA data.
  
```
  
```{r}
  # check the normality of the residuals for Age at maturity from the PFOA data.
  
  Age_pfoa_ano_res <- residuals(Age_pfoa_ano)
  
  plotNormalHistogram(Age_pfoa_ano_res) # print the histogram for the residuals for Age at maturity from the PFOA data.
  
```
  
```{r}
  # plot the qqplot for the residuals for Age at maturity from the PFOA data.
  
  qqnorm(residuals(Age_pfoa_ano),
         ylab = "Sample Quantiles for Residuals") # plot the qq-plot of the residuals of the variable 'Age at maturity'
  
  qqline(residuals(Age_pfoa_ano),
         col = "red")
  
```
  
```{r}
  # perform the ANOVA for Size at maturity from the PFOA data.
  
  Size_pfoa_ano <- lmer(Size_maturity ~ Treatment * Genotypes + (1|Genotypes: Replicates), data = PFOA_Data_new)
  
  print(anova(Size_pfoa_ano)) # print the ANOVA for Size at maturity from the PFOA data.
```
  
```{r}
  # check the normality of the residuals for Size at maturity from the PFOA data.
  
  Size_pfoa_ano_res <- residuals(Size_pfoa_ano)
  
  plotNormalHistogram(Size_pfoa_ano_res) # print the histogram for the residuals for Size at maturity from the PFOA data.
  
```
  
```{r}
  # plot the qqplot for the residuals for Size at maturity from the PFOA data.
  
  qqnorm(residuals(Size_pfoa_ano),
         ylab = "Sample Quantiles for Residuals") # plot the qq-plot of the residuals of the variable 'Size at maturity'
  
  qqline(residuals(Size_pfoa_ano),
         col = "red")
```   
  
```{r}
  # perform the ANOVA for Fecundity from the PFOA data.
  
  Fecundity_pfoa_ano <- lmer(Fecundity ~ Treatment * Genotypes + (1|Genotypes: Replicates), data = PFOA_Data_new)
  
  print(anova(Fecundity_pfoa_ano)) # print the ANOVA for Fecundity from the PFOA data.
  
```
  
```{r}
  isSingular(Fecundity_pfoa_ano, tol = 1e-4) # check if the model is singular
  
  
```
   this means some of the dimensions have been estimated as zero. This is because the model is too complex for the data.
```{r}
  # check the normality of the residuals for Fecundity from the PFOA data.
  
  Fecundity_pfoa_ano_res <- residuals(Fecundity_pfoa_ano)
  
  plotNormalHistogram(Fecundity_pfoa_ano_res) # print the histogram for the residuals for Fecundity from the PFOA data.
  
```
  


```{r}
  
  # plot the qqplot for the residuals for Fecundity from the PFOA data.
  
  qqnorm(residuals(Fecundity_pfoa_ano),
         ylab = "Sample Quantiles for Residuals") # plot the qq-plot of the residuals of the variable 'Fecundity'
  
  qqline(residuals(Fecundity_pfoa_ano),
         col = "red")
```

  
```{r}
  # perform the ANOVA for Interval between broods from the PFOA data.
  
  Interval_pfoa_ano <- lmer(Invterval_brood ~ Treatment * Genotypes + (1|Genotypes: Replicates), data = PFOA_Data_new)
  
  print(anova(Interval_pfoa_ano)) # print the ANOVA for Interval between broods from the PFOA data.
  
```
  

```{r}
  # check the normality of the residuals for Interval between broods from the PFOA data.
  
  qqnorm(residuals(Interval_pfoa_ano),
         ylab = "Sample Quantiles for Residuals") # plot the qq-plot of the residuals of the variable 'Interval between broods'
  
  qqline(residuals(Interval_pfoa_ano),
         col = "red")
```
  
  Micrpolastic data: Abu
  
```{r}
  # import the data for the micropalstic data from the Abu data.
  
  Micrplastic_Data <- read_excel(file.choose(), sheet = "Abu-PE")
  
  print(Micrplastic_Data) # print the data for the micropalstic data from the Abu data.
  
```
  

```{r}
  str(Micrplastic_Data) # check the structure of the data for the micropalstic data from the Abu data.
  
```
  
```{r}
  # check for missing values in the data for the micropalstic data from the Abu data.
  
   colSums(is.na(Micrplastic_Data))
  
  
```
  
  
```{r}
  # subset the required variables from the data for the micropalstic data from the Abu data.
  
  Micrplastic_Data_new <- Micrplastic_Data[, c("Replicates","Treatment", "Genotype", "Age_maturity", "Size_maturity", "Fecundity", "Interval_btwnbrds")]
  
  print(Micrplastic_Data_new) # print the subsetted data for the micropalstic data from the Abu data.
  
```
  
```{r}
  # remove missing values from the data for the micropalstic data from the Abu data.
  
  Microplastic_withou_NA <- Micrplastic_Data_new[complete.cases(Micrplastic_Data_new),]
  
  print(Microplastic_withou_NA) # print the data for the micropalstic data from the Abu data without missing values.
  
```
  
  
```{r}
  # log transform the data for the micropalstic data from the Abu data.
  
  Microplastic_log <- log(Microplastic_withou_NA[, c("Age_maturity", "Size_maturity", "Fecundity", "Interval_btwnbrds")])
  
  print(Microplastic_log) # print the log transformed data for the micropalstic data from the Abu data.
  
```
  
```{r}
  # convert the genotype and treatment variables as factors
  
  Genotype <- as.factor(Microplastic_withou_NA$Genotype)
  
  Treatment <- as.factor(Microplastic_withou_NA$Treatment)
```
  
```{r}
  # perform a pca on the log transformed data for the micropalstic data from the Abu data.
  
  Microplastic_pca <- prcomp(Microplastic_log)
  
  print(Microplastic_pca) # print the pca on the log transformed data for the micropalstic data from the Abu data.
  
```
  
```{r}
  
  summary(Microplastic_pca) # print the summary of the pca on the log transformed data for the micropalstic data from the Abu data.
  
```


```{r}
  # plot the pca on the log transformed data for the micropalstic data from the Abu data.
  
  Microplastic_pca_plot <- fviz_pca_ind(Microplastic_pca, habillage = Genotype, geom = "point")
  
  print(Microplastic_pca_plot) # print the pca plot on the log transformed data for the micropalstic data from the Abu data.

```
  

```{r}
  # biplot for the pca on the log transformed data for the micropalstic data from the Abu data.
  
  fviz_pca_biplot(Microplastic_pca, # plot the PCA
               col.ind = Genotype, # color by Genotype
              palette = c("LRV_0_1"="red","LR2_36_1"="black"), # color palette
                addEllipses = TRUE, # Concentration ellipses
                col.var="blue", # Variables color
                arrowsize=0.2, # Arrow size
               labelsize=3, # Label size
               geom.ind = "point", # show points only (nbut not "text")
               pointsize=1, # Point size
               pointshape=19, # Point shape
               mean.point=F,# Show mean point
              # xlim=c(-5,5),# x axis limits
               #ylim=c(-3,3), # y axis limits
               var.scale=0.5, # Scaling of the variables
               ellipse.type = "confidence", # Confidence ellipse
               legend.title = "Genotype", # Legend title
               repel = TRUE, # Avoid text overlapping
               )
```
  
  
```{r}
  # check for potential outliers in the data for the micropalstic data from the Abu data.
  
  U3 <- Microplastic_pca$x
  
  print(U3) # print the potential outliers in the data for the micropalstic data from the Abu data.
  
```
  
```{r}
  # make a qqplot of U.
  
  qplot(U3[, 1], U3[, 2], colour = factor(Treatment) ) + coord_equal()
  
  
```
  

```{r}  
  #Measuring Outliers
  apply(U3, 2, function(x) which( abs(x - mean(x)) > (3 * sd(x)) )) # print the outliers in the data for the micropalstic data from the Abu data.
  
  # the concensus is to consider data points that are beyond 3 standard deviation away from the mean.
  
```
  
  
```{r}
  # perform the summary statistics for the data for the micropalstic data from the Abu data.
  
  # Age at maturity
  
  Age_maturity_stat <- summarySE(Microplastic_withou_NA, measurevar = "Age_maturity", groupvars = c("Treatment", "Genotype"))  # print the summary statistics for the data for the micropalstic data from the Abu data.
  
  
  print(Age_maturity_stat) # print the summary statistics for the data for the micropalstic data from the Abu data.
  
```
  
```{r}
  
  # plot the reacion norm for the variable Age at maturity for the data for the micropalstic data from the Abu data.
  
  Age_maturity_plot_micro <- ggplot(Age_maturity_stat,
                                    aes(x = Treatment,
                                        y = Age_maturity,
                                        colour = Genotype,
                                        group = interaction(Genotype))) +
    geom_errorbar(aes(ymin = Age_maturity - se,
                      ymax = Age_maturity + se),
                  width = 0.1,
                  position = pd) +
    geom_line(position = pd) +
    theme(panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
          axis.line = element_line(colour = "black")) +
    labs(x = "Treatment",
         y = "Age at maturity events",
         colour = "Genotype")
  
  
  print(Age_maturity_plot_micro) # print the reacion norm for the variable Age at maturity for the data for the micropalstic data from the Abu data.
```
  
```{r}
  # summary sttaistics for the variable Size at maturity for the data for the micropalstic data from the Abu data.
  
  size_maturity_stat <- summarySE(Microplastic_withou_NA, measurevar = "Size_maturity", groupvars = c("Treatment", "Genotype"))  # print the summary statistics for the data for the micropalstic data from the Abu data.
  
  
  print(size_maturity_stat) # print the summary statistics for the data for the micropalstic data from the Abu data.
  
  
  
```
  

```{r}
  
  # plot the reaction norm for size at maturity for the data for the micropalstic data from the Abu data.
  
  size_maturity_plot_micro <- ggplot(size_maturity_stat,
                                    aes(x = Treatment,
                                        y = Size_maturity,
                                        colour = Genotype,
                                        group = interaction(Genotype))) +
    geom_errorbar(aes(ymin = Size_maturity - se,
                      ymax = Size_maturity + se),
                  width = 0.1,
                  position = pd) +
    geom_line(position = pd) +
    theme(panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
          axis.line = element_line(colour = "black")) +
    labs(x = "Treatment",
         y = "Size at maturity events",
         colour = "Genotype")
  
  print(size_maturity_plot_micro) # print the reaction norm for size at maturity for the data for the micropalstic data from the Abu data.
```
  

```{r}
  
  # summary statistics for the variable fecundity for the data for the micropalstic data from the Abu data.
  
  fucndity_stat <- summarySE(Microplastic_withou_NA, measurevar = "Fecundity", groupvars = c("Treatment", 
                "Genotype"))  # print the summary statistics for the data for the micropalstic data from the Abu data.
  
  print(fucndity_stat) # print the summary statistics for the data for the micropalstic data from the Abu data.
  
```
  

```{r}
  
  # plot the reaction norm for fecundity for the data for the micropalstic data from the Abu data.
  
  fecundity_plot_micro <- ggplot(fucndity_stat,
                                    aes(x = Treatment,
                                        y = Fecundity,
                                        colour = Genotype,
                                        group = interaction(Genotype))) +
    geom_errorbar(aes(ymin = Fecundity - se,
                      ymax = Fecundity + se),
                  width = 0.1,
                  position = pd) +
    geom_line(position = pd) +
    theme(panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
          axis.line = element_line(colour = "black")) +
    labs(x = "Treatment",
         y = "Fecundity events",
         colour = "Genotype")
  
  print(fecundity_plot_micro) # print the reaction norm for fecundity for the data for the micropalstic data from the Abu data.
```


```{r}
  # summary statistics for the variable interval between brood for the data for the microplastic data from the Abu data.
  
  interv_brood_stat <- summarySE(Microplastic_withou_NA, measurevar = "Interval_btwnbrds", groupvars = c("Treatment", 
                "Genotype"))  # print the summary statistics for the data for the micropalstic data from the Abu data.
  
  print(interv_brood_stat) # print the summary statistics for the data for the micropalstic data from the Abu data.
  
```
  
```{r}
  # plot the reaction norm for interval between brood for the data for the micropalstic data from the Abu data.
  
  int_brood_plot_micro <- ggplot(interv_brood_stat,
                                    aes(x = Treatment,
                                        y = Interval_btwnbrds,
                                        colour = Genotype,
                                        group = interaction(Genotype))) +
    geom_errorbar(aes(ymin = Interval_btwnbrds - se,
                      ymax = Interval_btwnbrds + se),
                  width = 0.1,
                  position = pd) +
    geom_line(position = pd) +
    theme(panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
          axis.line = element_line(colour = "black")) +
    labs(x = "Treatment",
         y = "Interval between brood events",
         colour = "Genotype")
  
  
  print(int_brood_plot_micro) # print the reaction norm for interval between brood for the data for the micropalstic data from the Abu data.
```
  
```{r}
  
  # Anova for Age at maturity for the data for the micropalstic data from the Abu data.
  
  Age_anova <- lmer(Age_maturity ~ Treatment * Genotype + (1|Genotype:Replicates), data = Microplastic_withou_NA) # print the Anova for Age at maturity for the data for the micropalstic data from the Abu data.
  
  anova(Age_anova) # print the Anova for Age at maturity for the data for the micropalstic data from the Abu data.
  
```
  
```{r}
  # check the normality of the residuals.
  
  micro <- residuals(Age_anova) # print the residuals for the Anova for Age at maturity for the data for the micropalstic data from the Abu data.
  
  plotNormalHistogram(micro) # print the residuals for the Anova for Age at maturity for the data for the micropalstic data from the Abu data.
  
```
  
```{r}
  # qpplot
  
  qqnorm(residuals(Age_anova),)
         ylab = "Sample Quantiles for Residuals" # plot the qq-plot of the residuals of the variable 'Fecundity'
  
  qqline(residuals(Age_anova),
         col = "red")
```

```{r}
  # Anova for Size at maturity for the data for the micropalstic data from the Abu data.
  
  size_anova <- lmer(Size_maturity ~ Treatment * Genotype + (1|Genotype:Replicates), data = Microplastic_withou_NA) # print the Anova for Size at maturity for the data for the micropalstic data from the Abu data.
  
  print(anova(size_anova)) # print the Anova for Size at maturity for the data for the micropalstic data from the Abu data.
  
```
  
```{r}
  # check the normality of the residuals.
  
  size_micro <- residuals(size_anova) # print the residuals for the Anova for Size at maturity for the data for the micropalstic data from the Abu data.
  
  plotNormalHistogram(size_micro) # print the residuals for the Anova for Size at maturity for the data for the micropalstic data from the Abu data.
  
```
  
```{r}
  # qpplot
  
  qqnorm(residuals(size_anova),)
         ylab = "Sample Quantiles for Residuals" # plot the qq-plot of the residuals of the variable 'Fecundity'
         
     qqline(residuals(size_anova),
         col = "red")
```
  
```{r}
  # Anova for Interval_brood for the data for the micropalstic data from the Abu data.
  
  interv_brood_anova <- lmer(Interval_btwnbrds ~ Treatment * Genotype + (1|Genotype:Replicates), data = Microplastic_withou_NA) # print the Anova for Interval_brood for the data for the micropalstic data from the Abu data.
  
  print(anova(interv_brood_anova)) # print the Anova for Interval_brood for the data for the micropalstic data from the Abu data.
  
```
  
```{r}
  # check the normality of the residuals.
  
  interv_brood_micro <- residuals(interv_brood_anova) # print the residuals for the Anova for Interval_brood for the data for the micropalstic data from the Abu data.
  
  plotNormalHistogram(interv_brood_micro) # print the residuals for the Anova for Interval_brood for the data for the micropalstic data from the Abu data.
  
```
 
  
```{r}
  # qpplot
  
  qqnorm(residuals(interv_brood_anova),)
         ylab = "Sample Quantiles for Residuals" # plot the qq-plot of the residuals of the variable 'Fecundity'
         
     qqline(residuals(interv_brood_anova),
         col = "red")
```

  PFOS Data: Abu

```{r}
  
  # import the PFOs data
  
  Pfos_data_abu <- read_excel(file.choose(), sheet = "PFOS_abu") # import the PFOs data
  
  print(Pfos_data_abu) # print the PFOs data
```
  
```{r}
  str(Pfos_data_abu) # print the structure of the PFOs data
  
```
  
```{r}
  colSums(is.na(Pfos_data_abu)) # print the number of NA's in the PFOs data
  
```
  
```{r}
  # remove the NA's from the PFOs data
  
  Pfos_without_na_abu <- Pfos_data_abu[complete.cases(Pfos_data_abu),] # remove the NA's from the PFOs data
  
  
  print(Pfos_without_na_abu) # print the PFOs data without NA's
```
  
```{r}
 
# subset the variables

Pfos_new_df <- Pfos_without_na_abu[,c("Replicates", "Age_maturity", "Size_maturity", "Fecundity", "Genotype", "Treatment", "Interval_btwnbrds")] # subset the variables
  

print(Pfos_new_df)
  
```
  
  
```{r} 
# Convert the Genotype and treatment variables as factors.

Genotyope <- as.factor(Pfos_new_df$Genotype) # Convert the Genotype variable as factors.

Treatment <- as.factor(Pfos_new_df$Treatment) # Convert the treatment variable as factors.

```
  
  
```{r}
# log transform the variables

log_Pfos_new_df <- log(Pfos_new_df[,c("Age_maturity", "Size_maturity", "Fecundity", "Interval_btwnbrds")]) # log transform the variables

print(log_Pfos_new_df) # print the log transformed variables

```
  
```{r}

# run the pca on the log transformed variables

pca_Pfos <- prcomp(log_Pfos_new_df, center = TRUE, scale. = TRUE) # run the pca on the log transformed variables

print(summary(pca_Pfos)) # print the summary of the pca

```
  
```{r}
print(pca_Pfos) # print the pca

```
  
```{r}
# plot the pca

pca_pfos_plot <- fviz_pca_ind(pca_Pfos, habillage = Pfos_new_df$Genotype, geom = "point" ) # plot the pca

print(pca_pfos_plot) # print the pca

```
  
```{r}
# plot the biplot

```

    
```{r}

# check for outliers

U4 <- pca_Pfos$x # check for outliers.

U4

```


```{r}

apply(U4, 2, function(x) which( abs(x - mean(x)) > (3 * sd(x)) )) # check for outliers.
```
  
```{r}
# summary stat of Age at maturity.

Age_pfos_stat <- summarySE(Pfos_new_df, measurevar = "Age_maturity", groupvars = c("Genotype", "Treatment")) # summary stat of Age at maturity.

print(Age_pfos_stat) # print the summary stat of Age at maturity.

```
  
```{r}
# plot the Age at maturity.
Age_pfos_plot <- ggplot(Age_pfos_stat,
                                    aes(x = Treatment,
                                        y = Age_maturity,
                                        colour = Genotype,
                                        group = interaction(Genotype))) +
    geom_errorbar(aes(ymin = Age_maturity - se,
                      ymax = Age_maturity + se),
                  width = 0.1,
                  position = pd) +
    geom_line(position = pd) +
    theme(panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
          axis.line = element_line(colour = "black")) +
    labs(x = "Treatment",
         y = "Age_maturity events",
         colour = "Genotype")

print(Age_pfos_plot) # print the plot of Age at maturity.
```

```{r}
# summary stat of Size at maturity.

size_pfos_stat <- summarySE(Pfos_new_df, measurevar = "Size_maturity", groupvars = c("Genotype", "Treatment")) # summary stat of Size at maturity.

print(size_pfos_stat) # print the summary stat of Size at maturity.

```
  
```{r}

# plot the reaction norm 

Size_pfos_plot <- ggplot(size_pfos_stat,
                                    aes(x = Treatment,
                                        y = Size_maturity,
                                        colour = Genotype,
                                        group = interaction(Genotype))) +
    geom_errorbar(aes(ymin = Size_maturity - se,
                      ymax = Size_maturity + se),
                  width = 0.1,
                  position = pd) +
    geom_line(position = pd) +
    theme(panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
          axis.line = element_line(colour = "black")) +
    labs(x = "Treatment",
         y = "Size at maturity",
         colour = "Genotype")


print(Size_pfos_plot) # print the plot of Size at maturity.
```

```{r}

# summary stat of Fecundity.

Fecundity_pfos_stat <- summarySE(Pfos_new_df, measurevar = "Fecundity", groupvars = c("Genotype", "Treatment")) # summary stat of Fecundity.

print(Fecundity_pfos_stat) # print the summary stat of Fecundity.

```
  
```{r}
# plot the reaction norm

Fecundity_pfos_plot <- ggplot(Fecundity_pfos_stat,
                                    aes(x = Treatment,
                                        y = Fecundity,
                                        colour = Genotype,
                                        group = interaction(Genotype))) +
    geom_errorbar(aes(ymin = Fecundity - se,
                      ymax = Fecundity + se),
                  width = 0.1,
                  position = pd) +
    geom_line(position = pd) +
    theme(panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
          axis.line = element_line(colour = "black")) +
    labs(x = "Treatment",
         y = "Fecundity",
  
       colour = "Genotype")

print(Fecundity_pfos_plot) # print the plot of Fecundity.
```

```{r}
# summary stat of Interval between broods.

interval_pfos_stat <- summarySE(Pfos_new_df, measurevar = "Interval_btwnbrds", groupvars = c("Genotype", "Treatment")) # summary stat of Interval between broods.


print(interval_pfos_stat) # print the summary stat of Interval between broods.

```
  
```{r}
# plot the reaction norm

interval_pfos_plot <- ggplot(interval_pfos_stat,
                                    aes(x = Treatment,
                                        y = Interval_btwnbrds,
                                        colour = Genotype,
                                        group = interaction(Genotype))) +
    geom_errorbar(aes(ymin = Interval_btwnbrds - se,
                      ymax = Interval_btwnbrds + se),
                  width = 0.1,
                  position = pd) +
    geom_line(position = pd) +
    theme(panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
          axis.line = element_line(colour = "black")) +
    labs(x = "Treatment",
         y = "Interval between broods",
         colour = "Genotype")


print(interval_pfos_plot) # print the plot of Interval between broods.
```


# Mixed chemical exposure
# -----------------------

# PFOA+PFOS: Tia

```{r}

# read the data

PFOA_PFOS_Tia <- read_excel(file.choose(), sheet = "PFOS_PFOA_Tia") # read the data

print(PFOA_PFOS_Tia) # print the data

```

```{r}
str(PFOA_PFOS_Tia) # check the structure of the data

```

```{r}
PFAs_Tia <- PFOA_PFOS_Tia[, c("Replicates", "Genotypes", "Treatment", "Age_maturation", "Size_maturity","Fecundity", "Interval_brood")] # select the columns of interest
```

```{r}
print(PFAs_Tia) # print the data
```

```{r}

PFAs_Tia$Genotypes <- as.factor(PFAs_Tia$Genotypes) # convert the Genotypes column to factor

PFAs_Tia$Treatment <- as.factor(PFAs_Tia$Treatment) # convert the Treatment column to factor

```

```{r}

colSums(is.na(PFAs_Tia)) # check for missing values

```

```{r}

PFAs_Tia [4:7] <- log(PFAs_Tia [4:7]) # log transformation of the data

print(PFAs_Tia) # print the data

```

```{r}

log_PFAS_Tia <- PFAs_Tia[, c("Age_maturation", "Size_maturity","Fecundity", "Interval_brood")] # select the columns of interest

print(log_PFAS_Tia) # print the data

```


```{r}
PCA_PFAS <- prcomp(log_PFAS_Tia, scale = TRUE) # PCA analysis

print(PCA_PFAS) # print the PCA analysis

```

```{r}
summary(PCA_PFAS) # summary of the PCA analysis

```
```{r}

Treatment <- as.factor(PFAs_Tia$Treatment) # convert the Treatment column to factor

Genotypes <- as.factor(PFAs_Tia$Genotypes) # convert the Genotypes column to factor

```


```{r}
PFAS_plot <- fviz_pca_ind(PCA_PFAS, habillage = Genotypes, geom = "point") # PCA 
```

```{r}

print(PFAS_plot) # print the PCA plot

```

```{r}
fviz_pca_biplot (PCA_PFAS, 
                 col.ind = Genotypes, 
                 geom.ind = "point",
                 palette = c("LRV-0-1" = "red", "LR2-36-01" = "black"),
                 addEllipses = TRUE,
                 col.var = "blue",
                 arrowsize = 0.1,
                 labelsize = 3,
                 pointsize = 1,
                 pointshape = 19,
                 mean.point = F,
                 var.scale = 0.5,
                 ellipse.type = "confidence",
                 legend.title = "Genotypes",
                 repel = TRUE
                 ) # PCA biplot
```

```{r}
U6 <- PCA_PFAS$x

print(U6) # print the PCA scores

```

```{r}
qplot(U6[,1], U6[,2], colour = Treatment, shape = Genotypes) + coord_equal() # PCA scores plot
```

```{r}
apply(U6, 2, function(x) which(abs(x -  mean(x)) > (2 * sd(x)))) # mean of the PCA scores

```

```{r}
# summary stat of Age at maturation.

Age_maturation_pfas_stat <- summarySE(PFOA_PFOS_Tia, measurevar = "Age_maturation", groupvars = c("Genotypes", "Treatment")) # summary stat of Age at maturation.


print(Age_maturation_pfas_stat) # print the summary stat of Age at maturation.

```

```{r}
# plot the reaction norm

Age_maturation_pfas_plot <- ggplot(Age_maturation_pfas_stat,
                                    aes(x = Treatment,
                                        y = Age_maturation,
                                        colour = Genotypes,
                                        group = interaction(Genotypes))) +
    geom_errorbar(aes(ymin = Age_maturation - se,
                      ymax = Age_maturation + se),
                  width = 0.1,
                  position = pd) +
    geom_line(position = pd) +
    theme(panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
          axis.line = element_line(colour = "black")) +
    labs(x = "Treatment",
         y = "Age at maturation",
         colour = "Genotypes")

print(Age_maturation_pfas_plot) # print the plot of Age at maturation.
```

```{r}
# summary stat of Size at maturity.

Size_maturity_pfas_stat <- summarySE(PFOA_PFOS_Tia, measurevar = "Size_maturity", groupvars = c("Genotypes", "Treatment")) # summary stat of Size at maturity.

print(Size_maturity_pfas_stat) # print the summary stat of Size at maturity.

```

```{r}
# plot the reaction norm

Size_maturity_pfas_plot <- ggplot(Size_maturity_pfas_stat,
                                    aes(x = Treatment,
                                        y = Size_maturity,
                                        colour = Genotypes,
                                        group = interaction(Genotypes))) +
    geom_errorbar(aes(ymin = Size_maturity - se,
                      ymax = Size_maturity + se),
                  width = 0.1,
                  position = pd) +
    geom_line(position = pd) +
    theme(panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
          axis.line = element_line(colour = "black")) +
    labs(x = "Treatment",
         y = "Size at maturity",
         colour = "Genotypes")

print(Size_maturity_pfas_plot) # print the plot of Size at maturity.
```

```{r}
# summary stat of Fecundity.

Fecundity_pfas_stat <- summarySE(PFOA_PFOS_Tia, measurevar = "Fecundity", groupvars = c("Genotypes", "Treatment")) # summary stat of Fecundity.

print(Fecundity_pfas_stat) # print the summary stat of Fecundity.

```

```{r}
# plot the reaction norm

Fecundity_pfas_plot <- ggplot(Fecundity_pfas_stat,
                                    aes(x = Treatment,
                                        y = Fecundity,
                                        colour = Genotypes,
                                        group = interaction(Genotypes))) +
    geom_errorbar(aes(ymin = Fecundity - se,
                      ymax = Fecundity + se),
                  width = 0.1,
                  position = pd) +
    geom_line(position = pd) +
    theme(panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
          axis.line = element_line(colour = "black")) +
    labs(x = "Treatment",
         y = "Fecundity",
         colour = "Genotypes")

print(Fecundity_pfas_plot) # print the plot of Fecundity.
```

```{r}
# summary stat of Interval between brood.

Interval_brood_pfas_stat <- summarySE(PFOA_PFOS_Tia, measurevar = "Interval_brood", groupvars = c("Genotypes", "Treatment")) # summary stat of Interval between brood.

print(Interval_brood_pfas_stat) # print the summary stat of Interval between brood.

```

```{r}
# plot the reaction norm

Interval_brood_pfas_plot <- ggplot(Interval_brood_pfas_stat,
                                    aes(x = Treatment,
                                        y = Interval_brood,
                                        colour = Genotypes,
                                        group = interaction(Genotypes))) +
    geom_errorbar(aes(ymin = Interval_brood - se,
                      ymax = Interval_brood + se),
                  width = 0.1,
                  position = pd) +
    geom_line(position = pd) +
    theme(panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
          axis.line = element_line(colour = "black")) +
    labs(x = "Treatment",
         y = "Interval between brood",
         colour = "Genotypes")

print(Interval_brood_pfas_plot) # print the plot of Interval between brood.

```

```{r}
# perform the ANOVA

Age_maturation_pfas_anova <- lmer(Age_maturation ~ Genotypes * Treatment + (1|Genotypes : Replicates), data = PFOA_PFOS_Tia) # perform the ANOVA


anova(Age_maturation_pfas_anova) # print the ANOVA table

```

```{r}
#tidy_Age_PFAS <- tidy(Age_maturation_pfas_anova) # tidy the ANOVA table

#write.csv(tidy_Age_PFAS, "tidy_Age_PFAS.csv") # write the ANOVA table to a csv file

```

```{r}

# perform the ANOVA

Size_maturity_pfas_anova <- lmer(Size_maturity ~ Genotypes * Treatment + (1|Genotypes : Replicates), data = PFOA_PFOS_Tia) # perform the ANOVA

anova(Size_maturity_pfas_anova) # print the ANOVA table

```

```{r}

# perform the ANOVA

Fecundity_pfas_anova <- lmer(Fecundity ~ Genotypes * Treatment + (1|Genotypes : Replicates), data = PFOA_PFOS_Tia) # perform the ANOVA

anova(Fecundity_pfas_anova) # print the ANOVA table

```

```{r}
# perofrm the ANOVA

Interval_brood_pfas_anova <- lmer(Interval_brood ~ Genotypes * Treatment + (1|Genotypes : Replicates), data = PFOA_PFOS_Tia) # perform the ANOVA

anova(Interval_brood_pfas_anova) # print the ANOVA table

```

```{r}
# import the data


MP_PFOA <- read_excel(file.choose(), sheet = "MP_PFOA_Tia") # import the data)


print(MP_PFOA) # print the data

```

```{r}

str(MP_PFOA) # structure of the data

```

```{r}
colSums(is.na(MP_PFOA)) # check for missing values

```

```{r}
MP_PFOA_data <- MP_PFOA %>% # create a new data frame with only the columns we need
    select(Replicates,Treatment, Genotypes, Age_maturity, Size_maturity, Fecundity, Interval_brood)

print(MP_PFOA_data) # print the new data frame
```

```{r}

MP_PFOA_data$Genotypes <- as.factor(MP_PFOA_data$Genotypes) # convert Genotypes to a factor

MP_PFOA_data$Treatment <- as.factor(MP_PFOA_data$Treatment) # convert Treatment to a factor

```


```{r}
MP_PFOA_data[4:7] <- log(MP_PFOA_data[4:7] + 0.5) # log transform the data

```

```{r}
print(MP_PFOA_data) # print the new data frame
```

```{r}
log_MP_PFOA_data <- MP_PFOA_data %>% # create a new data frame with only the columns we need
    select(Age_maturity, Size_maturity, Fecundity, Interval_brood)

print(log_MP_PFOA_data) # print the new data frame
```

```{r}
PCa_MP_Pfoa <- prcomp(log_MP_PFOA_data, center = TRUE, scale. = TRUE) # perform PCA

print(PCa_MP_Pfoa) # print the PCA

```

```{r}
summary(PCa_MP_Pfoa) # summary of the PCA

```

```{r}
Genotypes <- as.factor(MP_PFOA_data$Genotypes) # convert Genotypes to a factor

Treatment <- as.factor(MP_PFOA_data$Treatment) # convert Treatment to a factor

```

```{r}

MP_PFOA_plot <- fviz_pca_ind(PCa_MP_Pfoa,
                             habillage = Genotypes,
                             geom = "point")

print(MP_PFOA_plot) # print the PCA plot

```

```{r}
fviz_pca_biplot(PCa_MP_Pfoa,
                col.ind = Genotypes,
                geom = "point",
                 palette = c("LRV-0-1" = "red", "LR2-36-01" = "black"),
                 addEllipses = TRUE,
                 col.var = "blue",
                 arrowsize = 0.1,
                 labelsize = 3,
                 pointsize = 1,
                 pointshape = 19,
                 mean.point = F,
                 var.scale = 0.5,
                 ellipse.type = "confidence",
                 legend.title = "Genotypes",
                 repel = TRUE
                )

```

```{r}

U7 <- PCa_MP_Pfoa$x

print(U7) # print the PCA scores

```

```{r}
qplot(U7[,1], U7[,2],  colour = Treatment, shape = Genotypes) + coord_equal() # QQ plot of PCA scores

```

```{r}
apply(U7, 2, function
      (x) which (abs(x - mean(x)) > 3 * sd(x))) # check for outliers))))
```


```{r}

# summary statistics

Age_maturation_MP_PFOA <- summarySE(MP_PFOA_data, measurevar = "Age_maturity", groupvars = c("Treatment", "Genotypes"))
print(Age_maturation_MP_PFOA) # print the summary statistics
```

```{r}
# plot the reaction norm

Age_maturation_MP_PFOA_plot <- ggplot(Age_maturation_MP_PFOA,
                                    aes(x = Treatment,
                                        y = Age_maturity,
                                        colour = Genotypes,
                                        group = interaction(Genotypes))) +
    geom_errorbar(aes(ymin = Age_maturity - se,
                      ymax = Age_maturity + se),
                  width = 0.1,
                  position = pd) +
    geom_line(position = pd) +
    theme(panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
          axis.line = element_line(colour = "black")) +
    labs(x = "Treatment",
         y = "Age at maturation",
         colour = "Genotypes")

print(Age_maturation_MP_PFOA_plot) # print the reaction norm
```

```{r}
# summary statistics size at maturation

Size_maturation_MP_PFOA <- summarySE(MP_PFOA_data, measurevar = "Size_maturity", groupvars = c("Treatment", "Genotypes"))

print(Size_maturation_MP_PFOA) # print the summary statistics
```

```{r}

# plot the reaction norm

Size_maturation_MP_PFOA_plot <- ggplot(Size_maturation_MP_PFOA,
                                    aes(x = Treatment,
                                        y = Size_maturity,
                                        colour = Genotypes,
                                        group = interaction(Genotypes))) +
    geom_errorbar(aes(ymin = Size_maturity - se,
                      ymax = Size_maturity + se),
                  width = 0.1,
                  position = pd) +
    geom_line(position = pd) +
    theme(panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
          axis.line = element_line(colour = "black")) +
    labs(x = "Treatment",
         y = "Size at maturation",
         colour = "Genotypes")

print(Size_maturation_MP_PFOA_plot) # print the reaction norm
```

```{r}

# summary statistics fecundity

Fecundity_MP_PFOA <- summarySE(MP_PFOA_data, measurevar = "Fecundity", groupvars = c("Treatment", "Genotypes"))

print(Fecundity_MP_PFOA) # print the summary statistics
```

```{r}
#plot the reaction norm

Fecundity_MP_PFOA_plot <- ggplot(Fecundity_MP_PFOA,
                                    aes(x = Treatment,
                                        y = Fecundity,
                                        colour = Genotypes,
                                        group = interaction(Genotypes))) +
    geom_errorbar(aes(ymin = Fecundity - se,
                      ymax = Fecundity + se),
                  width = 0.1,
                  position = pd) +
    geom_line(position = pd) +
    theme(panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
          axis.line = element_line(colour = "black")) +
    labs(x = "Treatment",
         y = "Fecundity",
         colour = "Genotypes")

print(Fecundity_MP_PFOA_plot) # print the reaction norm
```

```{r}
# summary statistics interval between broods

Interval_brood_MP_PFOA <- summarySE(MP_PFOA_data, measurevar = "Interval_brood", groupvars = c("Treatment", "Genotypes"))

print(Interval_brood_MP_PFOA) # print the summary statistics
```

```{r}

# plot the reaction norm

Interval_brood_MP_PFOA_plot <- ggplot(Interval_brood_MP_PFOA,
                                    aes(x = Treatment,
                                        y = Interval_brood,
                                        colour = Genotypes,
                                        group = interaction(Genotypes))) +
    geom_errorbar(aes(ymin = Interval_brood - se,
                      ymax = Interval_brood + se),
                  width = 0.1,
                  position = pd) +
    geom_line(position = pd) +
    theme(panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
          axis.line = element_line(colour = "black")) +
    labs(x = "Treatment",
         y = "Interval between broods",
         colour = "Genotypes")

print(Interval_brood_MP_PFOA_plot) # print the reaction norm
```

```{r}

# perform anova

anova_MP_PFOA_age <- lmer(Age_maturity ~ Treatment * Genotypes +  (1|Genotypes : Replicates), data = MP_PFOA_data)

anova(anova_MP_PFOA_age)

```

```{r}
# perform anova

anova_MP_PFOA_size <- lmer(Size_maturity ~ Treatment * Genotypes +  (1|Genotypes : Replicates), data = MP_PFOA_data)

anova(anova_MP_PFOA_size)

```

```{r}
# perform anova

anova_MP_PFOA_fecundity <- lmer(Fecundity ~ Treatment * Genotypes +  (1|Genotypes : Replicates), data = MP_PFOA_data)

anova(anova_MP_PFOA_fecundity)

```

```{r}
# perform anova

anova_MP_PFOA_interval <- lmer(Interval_brood ~ Treatment * Genotypes +  (1|Genotypes : Replicates), data = MP_PFOA_data)

anova(anova_MP_PFOA_interval)

```

```{r}
# the alpha represents the statistical significance of the test.

# the p-value defiens the percentage of finding an effect in our samples that we did.

#  the p-value is only a measure of statistical significance, not of effect size.

# the p-value is the probability of finding an effect in our samples that we did, if there is no effect in the population.

# the standard error is a measure of the accuracy of our estimates.
```


# Mortality Analysis


```{r}
# load packages

library(rms) # this package is used to create the data distribution. its installation depends on the installation of the kableExtra package.

```

```{r}
# load the data

PET_mortality <- read_excel(file.choose(), sheet = "PET_Mortality")

print(PET_mortality) # print the data
```

```{r}
Data_distr <- datadist(PET_mortality) # create the data distribution

options(datadist = "Data_distr") # set the data distribution

```

```{r}
# convert the variable Genotype to a factor

PET_mortality$Genotype <- as.factor(PET_mortality$Genotype)

PET_mortality$Treatment <- as.factor(PET_mortality$Treatment)


```

```{r}
# create the survival plot

surv_PET_plot <- psm(Surv(Day_mortality, Mortality) ~ Genotype, data = PET_mortality) # create the survival plot
```

```{r}

# print the survival plot

print(surv_PET_plot)

```

```{r}
# create the survival plot

survplot(surv_PET_plot, Genotype = NA, conf.int = FALSE,xlim = c(0,21), ylim=c(0,1), conf = 'bands', col=c("red","black"),fun= function(y) {(1 - y)}, label.curves=list(keys='lines'));title('Survival_PET')
```
```{r}

library(blme) # load the package

```



```{r}
# anova for mortality data

#model_PET <- bglmer(Mortality ~ Treatment * Genotype + (1|Genotype:Replicates), data = PET_mortality, family = binomial) # create the mode the anova table

#anova(model_PET) # print the anova table
```

```{r}
```


```{r}
model_P <- glm(Mortality ~ Treatment * Genotype , data = PET_mortality, family = binomial) # create the model

car::Anova(model_P) # print the anova table
```


# PTA Analysis- PHEs(Florian)


```{r}

PheData <- read_excel(file.choose(), sheet = "Sheet1")

PheData

```




```{r}
# convert the variables to factors

PheData$Treatment <- factor(PheData$Treatment, levels = c("control", "PHE"))

PheData$Lake_Phase <- factor(PheData$Lake_Phase, levels = c("Recovery", "Pesticide", "Eutrophic", "Semi-Pristine"))

```



```{r}
PheDatawithoutNAs <- PheData[complete.cases(PheData),] # remove the missing values

PheDatawithoutNAs

```




```{r}
# log transformation of the variables

PheDatawithoutNAs[,5:8] <- log(PheDatawithoutNAs[5:8]+0.5,2)

print(PheDatawithoutNAs) # print the data
```

```{r}
# create your table data

PHE <- PheDatawithoutNAs[PheDatawithoutNAs$Treatment == "PHE",] # create the PET data

control <- PheDatawithoutNAs[PheDatawithoutNAs$Treatment == "control",] # create the control data

```


```{r}
taxa <- as.factor(PheDatawithoutNAs[[3]]) # create the taxa variable
```

```{r}

print(taxa) # print the taxa variable
```

```{r}

level <- as.factor(PheDatawithoutNAs[[4]]) # create the level variable

print(level) # print the level variable
```

```{r}

Y <- as.matrix(PheDatawithoutNAs[-c(1:4)]) # create the Y matrix

print(Y) # print the Y matrix
```

```{r}
taxaBylevel <- as.factor(paste(taxa, level)) # create the taxaBylevel variable)

print(taxaBylevel) # print the taxaBylevel variable
```

```{r}
Y <- prcomp(Y)$x # perform the PCA
```

```{r}
print(Y) # print the Y matrix
```

```{r}
#Basic data param,,eters (n=#spec, p=#ldmk, k=#dim)
n <- length(levels(taxa)) # create the n variable
n  #was n.taxa
```

```{r}

p <- length(levels(level)) # create the p variable

p  #was n.level
```

```{r}

k <- ncol(Y) # create the k variable
k #dimensions of phenotypic data

```

```{r}
#manova

lm.full <- lm(Y~ taxa * level, model = T, x = T, y = T, qr = T) # create the model

yhat.full <- predict(lm.full) # predict the model

```

```{r}

summary(manova(lm.full)) # print the summary of the model

#summary(lm.full) # print the summary of the model
```


```{r}

#yhat.full
```



```{r}
# for resid randomization (used later)
lm.red <- lm(Y ~ taxa +level, model = T, x = T, y = T, qr = T) # create the model just for the covariate

yhat.red <- predict(lm.red) # predict the model

res.red <- resid(lm.red) # create the residuals

res.red
```


```{r}
lsmeans.obs <- NULL
for (i in 1:k) {
  mean.temp <- tapply(yhat.full[,i], taxaBylevel, mean)
  lsmeans.obs <- cbind(lsmeans.obs, mean.temp)  
}

lsmeans.obs

```
-The least square means provides a robust estimates of the population means, accounting for the effects of the other variables in the model.
- The least square means are the means of the dependent variable at each level of the independent variable, adjusted for the other independent variables in the model.
- The Ls means are used to represent the average trajectory of phenotypic change for each taxon at each level of the independent variable.

- the size and direction of the trajectories are quantified and statistically compared across taxa and levels of the independent variable.

```{r}
arrayspecs <- function(A){
  n.m <-NULL # n.m stands for new means
  for(i in 1:n){
    temp <-as.matrix(A[((1+(i-1)*p):(i*p)),1:k])
    n.m <-cbind(n.m, temp)}
  trajectories <- array(n.m, dim = c(p, k, n))
}

```
### function calculating Trajectory attributes


```{r}
# Pathlength distance
pathdist<-function(M) {as.matrix(dist(M))}
trajsize<-function(M){
  traj.pathdist<-array(0,dim=c(n,1))   		#loop across trajectories
  for (i in 1:n){
    temp<-pathdist(M[,,i])
    for (j in 1:(p-1)){
      traj.pathdist[i]<-traj.pathdist[i]+temp[j,j+1]
    }
  }
  traj.size.dist<-as.matrix(dist(traj.pathdist))		#TrajSizeDiff
}

#trajectory direction 
orient<-function(M) {(svd(var(M))$v[1:k,1])} 	#find orientation

trajorient<-function(M){
  traj.orient<-array(NA,dim=c(n,k))   		#loop across trajectories
  check.1<-array(NA,dim=c(n))
  for (i in 1:n){
    temp<-orient(M[,,i])
    traj.orient[i,]<-temp
    check.1[i]<-M[1,,i]%*%traj.orient[i,]  #check startingpoint location
    check.1[i]<-check.1[i]/abs(check.1[i])
    if(check.1[i]==-1) traj.orient[i,]<--1*traj.orient[i,]
  }
  options(warn=-1)				#b/c acos of 1 (e.g, on diagonal) yields warning
  traj.ang.diff<-(180/pi)*acos(traj.orient%*%t(traj.orient))
  #diag(traj.ang.diff)<-0
}


```


```{r}
#trajectory shape
### GPA: following J.claude 2008; Morphometrics in R

trans <-function(A){scale(A, scale=F)} ##TRANSLATION


csize<-function(A)  ##CSIZE
{p<-dim(A)[1]
size<-sqrt(sum(apply(A,2,var))*(p-1))
list("centrois_size"=size, "scaled"= A/size)
}
  
  
mshape<-function(A){apply(A,c(1,2), mean)}  #meanshape

pPsup<- function(M1,M2){                    ## OPA rotation 1-->2
  k<-ncol(M1)
  Z1<-trans(csize(M1)[[2]])
  Z2<-trans(csize(M2)[[2]])
  sv<-svd(t(Z2)%*%Z1)
  U<-sv$u; V<-sv$u;Delt<-sv$d
  sig<-sign(det(t(Z1)%*%Z2))
  Delt[k]<-sig*abs(Delt[k]); V[,k]<-sig*V[,k]
  Gam<-U%*%t(V)
  beta<-sum(Delt)
  list(Mp1=beta*Z1%*%Gam,Mp2=Z2,rotation=Gam,scale=beta,
       df=sqrt(1-beta^2))
}
pgpa<-function(A)
{p<-dim(A)[1]; k<-dim(A)[2]; n<-dim(A)[3]  
temp2<-temp1<-array(NA,dim=c(p,k,n)); Siz<-numeric(n)#; Qm2<-numeric(n)
for (i in 1:n)
{Acs<-csize(A[,,i])
Siz[i]<-Acs[[1]]
temp1[,,i]<-trans(Acs[[2]])}
Qm1<-dist(t(matrix(temp1,k*p,n)))
Q<-sum(Qm1); iter<-0
while (abs(Q)> 0.00001)
{for(i in 1:n){
  M<-mshape(temp1[,,-i])
  temp2[,,i]<-pPsup(temp1[,,i],M)[[1]]}
  Qm2<-dist(t(matrix(temp2,k*p,n)))
  Q<-sum(Qm1)-sum(Qm2)
  Qm1<-Qm2
  iter=iter+1
  temp1<-temp2}
list("rotated"=temp2,"it.number"=iter,"Q"=Q,"intereucl.dist"=Qm2,"mshape"=
       csize(mshape(temp2))[[2]],"cent.size"=Siz)
}

```


```{r}
## loop for GPA and shape distances
trajshape <- function(M){
  x<-pgpa(M)
  traj.shape.dist<-as.matrix(dist(x$intereucl.dist))
}

```


```{r}
## TrajectrorySummaryStat

sumstat<-function(M){
  M<-as.dist(M)
  x<-if(length(M)>1)(x=var(M)) else 0
  
}
```


```{r}

#########Main Loop########

traj.specs.obs<-arrayspecs(lsmeans.obs) #lsmeans.obs is the output of the main loop
trajsize.obs<-trajsize(traj.specs.obs)
trajdir.obs<-trajorient(traj.specs.obs)
diag(trajdir.obs)<-0 #b/c some NA/N values on diagonal)
trajshape.obs<-trajshape(traj.specs.obs)
sumstatsize.obs<-sumstat(trajsize.obs)
sumstatdir.obs<-sumstat(trajdir.obs)
sumstatshape.obs<-sumstat(trajshape.obs)



```

```{r}

#### PERMUTATION Procedure

permute<-1000
line<-nrow(Y)
PSize<-POrient<-PShape<-array(1,dim=c(n,n))
PSumSize<-PSumOrient<-PSumShape<-1
for(i in 1:permute){
  line.rand<-sample(line,replace=FALSE)
  res.temp<-cbind(line.rand,res.red)
  z<-(order(line.rand))
  res.temp2<-as.matrix(res.temp[z,])
  res.p<-res.temp2[,-1] # Rows of residual are now randomized
  y.rand<-yhat.red+res.p
  yhat.rand<-predict(lm(y.rand~taxa*level,model=T,x=T,y=T,qr=T))
  
  lsmeans.rand<-NULL
  for (j in 1:k){
    mean.temp<-tapply(yhat.rand[,j],taxaBylevel, mean)
    lsmeans.rand<-cbind(lsmeans.rand,mean.temp)
  }
  traj.specs.rand<-arrayspecs(lsmeans.rand)
  trajsize.rand<-trajsize(traj.specs.rand)
  trajdir.rand<-trajorient(traj.specs.rand)
  diag(trajdir.rand)<-0 #b/c some NA/N values on diagonal)
  trajshape.rand<-trajshape(traj.specs.rand)
  sumstatsize.rand<-sumstat(trajsize.rand)
  sumstatdir.rand<-sumstat(trajdir.rand)
  sumstatshape.rand<-sumstat(trajshape.rand)
  for(j in 1:n){
    for(jj in 1:n){
      PSize[j,jj]<-if(trajsize.rand[j,jj]>=trajsize.obs[j,jj])
        (PSize[j,jj]+1) else PSize[j,jj]
      POrient[j,jj]<-if(trajdir.rand[j,jj]>=trajdir.obs[j,jj])
        (POrient[j,jj]+1) else POrient[j,jj]
      PShape[j,jj]<-if(trajshape.rand[j,jj]>=trajshape.obs[j,jj])
        (PShape[j,jj]+1) else PShape[j,jj]
    }
  }
  PSumSize<-if(sumstatsize.rand>=sumstatsize.obs) (PSumSize+1) else PSumSize
  PSumOrient<-if(sumstatdir.rand>=sumstatdir.obs) (PSumOrient+1) else PSumOrient
  PSumShape<-if(sumstatshape.rand>=sumstatshape.obs) (PSumShape+1) else PSumShape
} #end of permutation loop
for (j in 1:n){
  for(jj in 1:n){
    PSize[j,jj]<-PSize[j,jj]/(permute+1)
    POrient[j,jj]<-POrient[j,jj]/(permute+1)
    PShape[j,jj]<-PShape[j,jj]/(permute+1)
  }
}
PSumSize<-PSumSize/(permute+1)
PSumOrient<-PSumOrient/(permute+1)
PSumShape<-PSumShape/(permute+1)

```

```{r}
trajsize.obs # trajectore magnitude, length of line
PSize
trajdir.obs # trajectory direction, distance between two dots
POrient 
#trajshape.obs # trajectory shape, distance between two lines
#PShape
```

```{r}
###NOTE: summary statistics only valid for 2+ trajectories!!
sumstatsize.obs
PSumSize
sumstatdir.obs
PSumOrient
#sumstatshape.obs
#PSumShape
```

```{r}
#############Plot Data and LS means
plot(Y[,1:2], type="n", xlab="PC1", ylab="PC2", asp=1)
YY=cbind(taxa,level,Y)
points(YY[,3:4],col=taxa, pch=c(1,19)[as.numeric(level)])
for(i in 1:n){
  for(j in 1:(p-1)){
    points(traj.specs.obs[(j:(j+1)),1,i],traj.specs.obs[(j:(j+1)),2,i],type="l",pch=21,col="black")
    
  }
}
for (i in 1:n){
  for(j in 2:(p-1)){
    points(traj.specs.obs[j,1,i],traj.specs.obs[j,2,i],pch=21,col="red", cex=1.5)
  }
}
for(i in 1:n){
  points(traj.specs.obs[1,1,i],traj.specs.obs[1,2,i],pch=21,col="blue", cex=1.5, bg="white")
}
for(i in 1:n){
  points(traj.specs.obs[p,1,i],traj.specs.obs[p,2,i],pch=21,col="black", cex=1.5, bg="black")
}
```

# Manova DA
```{r}

print(Complete_Data)
```

```{r}

mano_Data <- Complete_Data[-c(5:6, 8:9)]

print(mano_Data)
```

```{r}

Y <- cbind(mano_Data$Age_maturity, mano_Data$Fecundity, mano_Data$Size_maturity, mano_Data$Interval_brood)

Y

```

```{r}

model <- manova(log(Y)~ Treatment * Genotypes, data = mano_Data)

summary(model, test = "Pillai")

```

```{r}
resid_model <- residuals(model)

plotNormalHistogram(resid_model)

```

```{r}
qqnorm(residuals(model))

qqline(residuals(model),
       col = "red")

```

```{r}
# In evolutionary biology, the 'multivariate phenotype' of an individual can be defined as a vector of either known or assumed related traits values

# the relationship between phenotype and genotype is influence by both genteic and environmental factors.

# here, we quantify the magnitude of phenotypic change and its direction in phenotype space.


```






##########UPSTREAM ANALYSIS
```{r}

TEMP_PH <- read_excel(file.choose(), sheet = "Sheet1")

TEMP_PH

```


```{r}

str(TEMP_PH)

```
```{r}

completeCases_TEMP_PH <- TEMP_PH[complete.cases(TEMP_PH),]

completeCases_TEMP_PH



```


```{r}
log_PH_TEMP <- log(completeCases_TEMP_PH[1:2] + 0.5)

log_PH_TEMP

```

```{r}

pca_PH_TEMP <- prcomp(log_PH_TEMP, scale = TRUE)

pca_PH_TEMP

```

```{r}
summary(pca_PH_TEMP)

```

```{r}
U_TP <- pca_PH_TEMP$x
  
print(U_TP)
```
  
```{r}
  qplot(U_TP[, 1], U_TP[, 2] ) + coord_equal()
```

```{r}

 #Measuring Outliers
 apply(U_TP, 2, function(x) which( abs(x - mean(x)) > (3 * sd(x)) ))  
```
 


  
```{r}
 U_no_outliers <- U_TP

outliers <- apply(U_TP, 2, function(x) which( abs(x - mean(x)) > (3 * sd(x)) )) # find outliers

#for (i in 1:ncol(U_TP)) {
 # U_no_outliers[outliers[, i], i] <- NA
#}


```

  
```{r}
  
  for (i in 1:ncol(U_TP)) {
   U_no_outliers[outliers[[i]], i] <- NA
  }
```
  
```{r}
  U_no_outliers 
  
```
  
```{r}
  
  qplot(U_no_outliers[, 1], U_no_outliers[, 2] ) + coord_equal()
   
```
  
######Synergistic and additive effects
```{r}
# Define the null model
# compute the expected additive effect.
# compare the observed effects.
# statistical analysis
# visualisation; e.g. ternary plots or response matrics
# interpretation: differentiate between a synergisitc or antagonisic effect based on  the direction and magnituted of the deviation from additivity.
# install package multiplestressor

#loading up an example dataset from the multiplestressR package

df <-  multiplestressR::survival

df


```
%>% %>% 
```{r}


#calculating effect sizes
df <- effect_size_additive(Control_N = df$Sample_Size_Control,
Control_SD = df$Standard_Deviation_Control,
Control_Mean = df$Mean_Control,
StressorA_N = df$Sample_Size_Temperature,
StressorA_SD = df$Standard_Deviation_Temperature,
StressorA_Mean = df$Mean_Temperature,
StressorB_N = df$Sample_Size_pH,
StressorB_SD = df$Standard_Deviation_pH,
StressorB_Mean = df$Mean_pH,
StressorsAB_N = df$Sample_Size_Temperature_pH,
StressorsAB_SD = df$Standard_Deviation_Temperature_pH,
StressorsAB_Mean = df$Mean_Temperature_pH,
Significance_Level = 0.05)

```


```{r}
#classifying interactions
df <- classify_interactions(effect_size_dataframe = df,
assign_reversals = TRUE,
remove_directionality = F)


```


```{r}

#generate summary plots
df_plots <- summary_plots(effect_size_dataframe = df,
Significance_Level = 0.05)

```

```{r}
df_plots
```

```{r}
# compute the standardised effect size.
library(readxl)
library(lme4)
library(ggplot2)
library(rms)
library(DescTools)
```


```{r}
data <- read_excel("~/life-history-traits-analysis/All.xlsx")
data
```

#############Partitioning matric analysis################

#########################################
```{r}
# combined stressors

# Planned contrast 1: LRV0_1 vs LR2-36-1
d <- dim(sub_PC1 <- data[(data$Treatment == "PFOS_PFOA" | data$Treatment == "MP_PFOS_PFOA") & (data$Genotypes == "LRV-0-1" | data$Genotypes == "LR2-36-01"),]) #
sub_PC1 <- array(NA,dim=d) # create an empty array

sub_PC1
```

```{r}
colnames(sub_PC1) <- colnames(data) # copy column names
```

```{r}

sub_PC1 <- as.data.frame(sub_PC1) # convert to data frame.

sub_PC1
```

```{r}
sub_PC1$Treatment <- as.character(data$Treatment[(data$Treatment == "PFOS_PFOA" | data$Treatment == "MP_PFOS_PFOA") & (data$Genotypes == "LRV-0-1" | data$Genotypes == "LR2-36-01")]) # copy the treatment column

```

```{r}
sub_PC1$Replicates <- as.character(data$Replicates[(data$Treatment == "PFOS_PFOA" | data$Treatment == "MP_PFOS_PFOA") & (data$Genotypes == "LRV-0-1" | data$Genotypes == "LR2-36-01")])

sub_PC1$Genotypes <- as.character(data$Genotypes[(data$Treatment == "PFOS_PFOA" | data$Treatment == "MP_PFOS_PFOA") & (data$Genotypes == "LRV-0-1" | data$Genotypes == "LR2-36-01")])

```


```{r}

sub_PC1[,c(2,5:d[2])] <- data[(data$Treatment == "PFOS_PFOA" | data$Treatment == "MP_PFOS_PFOA") & (data$Genotypes == "LRV-0-1" | data$Genotypes == "LR2-36-01"),c(2,5:d[2])] # copy the data

sub_PC1
```

```{r}
sub_PC1$Treatment <- as.factor(sub_PC1$Treatment)
sub_PC1$Replicates <- as.factor(sub_PC1$Replicates)
sub_PC1$Genotypes <- as.factor(sub_PC1$Genotypes)
sub_PC1


```


```{r}

# Here we set the factor contrasts to make sure we have a 'directional' comparison, 
#from the oldest to the middle population and environment

contrasts(sub_PC1$Treatment) <- c(1,0)
contrasts(sub_PC1$Genotypes) <- "contr.treatment"
```

```{r}
#remplace sumNeoNpop, sizeNpop and adultNpop
mod_PC1 <- lmer(Fecundity ~ Genotypes + Treatment + Genotypes*Treatment + (1|Genotypes:Replicates), data=sub_PC1)
# These error messages mean its struggling to estimate the variance-covariance matrix needed for the fixed effects. 
# Will probably have to drop them for these rediced models.
summary(mod_PC1)
Anova(mod_PC1)
#mod_PC1 <- lm(Fecundity ~ Genotypes + Treatment + Genotypes*Treatment, data=sub_PC1)
#summary(mod_PC1)
#Anova(mod_PC1)

```

```{r}

coefficients <- coef(mod_PC1)
coefficients
```

```{r}
standard_error <-  summary(mod_PC1)$coefficients[,"Std. Error"]
standard_error
```

```{r}

coefficients %>% as.list() %>% unlist() %>% as.numeric(coefficients)
standard_error <- as.numeric(standard_error)

t_values <- coefficients/standard_error
t_values
```

```{r}
is.numeric(coefficients)
```



```{r}


## Planned contrasts 2: LR2-36-01 --> LRV-0-1: MP_PFOA---->MP_PFOS_PFOA
d <- dim(sub_PC2 <- data[(data$Treatment == "MP_PFOS_PFOA" | data$Treatment == "MP_PFOA") & (data$Genotypes == "LRV-0-1" | data$Genotypes == "LR2-36-01"),])

d
```

```{r}
sub_PC2 <- array(NA,dim=d)
colnames(sub_PC2) <- colnames(data)
sub_PC2 <- as.data.frame(sub_PC2)


sub_PC2

```

```{r}


sub_PC2$Treatment <- as.character(data$Treatment[(data$Treatment == "MP_PFOS_PFOA" | data$Treatment == "MP_PFOA") & (data$Genotypes == "LRV-0-1" | data$Genotypes == "LR2-36-01")])

sub_PC2$Replicates <- as.character(data$Replicates[(data$Treatment == "MP_PFOS_PFOA" | data$Treatment == "MP_PFOA") & (data$Genotypes == "LR2-36-01" | data$Genotypes == "LRV-0-1")])

sub_PC2$Genotypes <- as.character(data$Genotypes[(data$Treatment == "MP_PFOS_PFOA" | data$Treatment == "MP_PFOA") & (data$Genotypes == "LR2-36-01" | data$Genotypes == "LRV-0-1")])

sub_PC2[,c(2,5:d[2])] <- data[(data$Treatment == "MP_PFOS_PFOA" | data$Treatment == "MP_PFOA") & (data$Genotypes == "LR2-36-01" | data$Genotypes == "LRV-0-1"),c(2,5:d[2])]

sub_PC2$Treatment <- as.factor(sub_PC2$Treatment)
sub_PC2$Replicates <- as.factor(sub_PC2$Replicates)
sub_PC2$Genotypes <- as.factor(sub_PC2$Genotypes)

sub_PC2

```


```{r}


# Here we set the factor contrasts to make sure we have a 'directional' comparison, from the oldest to the middle population and environment
contrasts(sub_PC2$Treatment)
contrasts(sub_PC2$Genotypes) <- c(1,0)

#Models with and without random efect 
##remplace sumNeoNpop, sizeNpop and adultNpop
mod_PC2 <- lmer(Age_maturiy ~ Genotypes + Treatment + Genotypes*Treatment + (1|Genotypes:Replicates), data=sub_PC2)
summary(mod_PC2)
Anova(mod_PC2)
mod_PC2 <- lm(Age_maturiy ~ Genotypes + Treatment + Genotypes*Treatment, data=sub_PC2)
summary(mod_PC2)
Anova(mod_PC2)

```




```{r}

##Single stress
##Planned contrasts 3: LR2-36-01 --> LRV-0-1 (PFOA --> PET)
d <- dim(sub_PC11 <- data[(data$Treatment == "PFOA" | data$Treatment == "PET") & (data$Genotypes == "LRV-0-1" | data$Genotypes == "LR2-36-01"),])
sub_PC11 <- array(NA,dim=d)
colnames(sub_PC11) <- colnames(data)
sub_PC11 <- as.data.frame(sub_PC11)
sub_PC11$Treatment <- as.character(data$Treatment[(data$Treatment == "PFOA" | data$Treatment == "PET") & (data$Genotypes == "LRV-0-1" | data$Genotypes == "LR2-36-01")])
sub_PC11$Replicates <- as.character(data$Replicates[(data$Treatment == "PFOA" | data$Treatment == "PET") & (data$Genotypes == "LRV-0-1" | data$Genotypes == "LR2-36-01")])
sub_PC11$Genotypes <- as.character(data$Genotypes[(data$Treatment == "PFOA" | data$Treatment == "PET") & (data$Genotypes == "LRV-0-1" | data$Genotypes == "LR2-36-01")])
sub_PC11[,c(2,5:d[2])] <- data[(data$Treatment == "PFOA" | data$Treatment == "PET") & (data$Genotypes == "LRV-0-1" | data$Genotypes == "LR2-36-01"),c(2,5:d[2])]


sub_PC11$Treatment <- as.factor(sub_PC11$Treatment)
sub_PC11$Genotypes <- as.factor(sub_PC11$Genotypes)
contrasts(sub_PC11$Treatment) <- c(1,0)
contrasts(sub_PC11$Genotypes) <- "contr.treatment"
```

```{r}
%>% 

#Models with and without random efect 
##remplace sumNeoNpop, sizeNpop and adultNpop
mod_PC11 <- lmer(Age_maturiy ~ Genotypes + Treatment + Genotypes*Treatment + (1|Genotypes:Replicates), data=sub_PC11)
summary(mod_PC11)
Anova(mod_PC11)
mod_PC11 <- lm(Age_maturiy ~ Genotypes + Treatment + Genotypes*Treatment, data=sub_PC11)
summary(mod_PC11)
Anova(mod_PC11)
```

```{r}
##Planned contrasts 4: LRV-0-1 --> , LR2-36-01 (PFOS --> PFOA)
d <- dim(sub_PC21 <- data[(data$Treatment == "PFOS" | data$Treatment == "PFOA") & (data$Genotypes == "LRV-0-1" | data$Genotypes == "LR2-36-01"),])
sub_PC21 <- array(NA,dim=d)
colnames(sub_PC21) <- colnames(data)
sub_PC21 <- as.data.frame(sub_PC21)
sub_PC21$Treatment <- as.character(data$Treatment[(data$Treatment == "PFOS" | data$Treatment == "PFOA") & (data$Genotypes == "LRV-0-1" | data$Genotypes == "LR2-36-01")])
sub_PC21$Replicates <- as.character(data$Replicates[(data$Treatment == "PFOS" | data$Treatment == "PFOA") & (data$Genotypes == "LRV-0-1" | data$Genotypes == "LR2-36-01")])
sub_PC21$Genotypes <- as.character(data$Genotypes[(data$Treatment == "PFOS" | data$Treatment == "PFOA") & (data$Genotypes == "LRV-0-1" | data$Genotypes == "LR2-36-01")])
sub_PC21[,c(2,5:d[2])] <- data[(data$Treatment == "PFOS" | data$Treatment == "PFOA") & (data$Genotypes == "LRV-0-1" | data$Genotypes == "LR2-36-01"),c(2,5:d[2])]

sub_PC21$Treatment <- as.factor(sub_PC21$Treatment)
sub_PC21$Genotypes <- as.factor(sub_PC21$Genotypes)
contrasts(sub_PC21$Treatment)
contrasts(sub_PC21$Genotypes) <- c(1,0)

```
```{r}

#Models with and without random efect 
##remplace sumNeoNpop, sizeNpop and adultNpop
mod_PC22 <- lmer(Age_maturiy ~ Genotypes + Treatment + Genotypes*Treatment + (1|Genotypes:Replicates), data=sub_PC21)
summary(mod_PC22)
Anova(mod_PC22)
mod_PC22 <- lm(Age_maturiy ~ Genotypes + Treatment + Genotypes*Treatment, data=sub_PC21)
summary(mod_PC22)
Anova(mod_PC22)
boxplot(Fecundity ~ Genotypes*Treatment, data=sub_PC21)


```

#---------------------------------------
#Table S2 t-test syn ant add
#---------------------------------------

```{r}
# to assess deviation from the null additive model:
# 1. fit the model using such as a linear model
# 2. extract coeffients and standard errors from the model summary.
# 3. calculate the t-statistic and p-value for the test of the null hypothesis by dividing the coefficient by the standard error and using the t-distribution with n-2 degrees of freedom.
# 4. use the t-distibution to calculate the p-value associated with t-statistic.












```

```{r}
SynAdd <- read_excel("SynAddAnt.xlsx")

SynAdd


```

```{r}
synadd <-complete.cases(SynAdd)
synadd
```

```{r}
SynAdd <- SynAdd[complete.cases(SynAdd),]
SynAdd

```


```{r}


SynAdd$treatment <- factor(SynAdd$treatment, levels = c("MP", "PFOS", "PFOA", "MP_PFOA", "PFOS_PFOA","MP_PFOS_PFOA"))

SynAdd$Genotypes <- factor(SynAdd$Genotypes, levels = c("LRV-0-1", "NULL-LRV-0-1","LR2-36-01", "NULL-LR2-36-01"))

SynAdd$trait <- factor(SynAdd$trait, levels = c("Age_maturiy","Size_maturity","Fecundity", "Interval_brood"))

```


```{r}

# Create the ggplot
ggplot(SynAdd, aes(x=treatment, y=SMD, fill=Genotypes)) + 
  geom_bar(stat="identity", position=position_dodge()) +
  geom_errorbar(aes(ymin=SMD-sd, ymax=SMD+sd), width=0,position=position_dodge(.9)) + 
  theme_bw() + facet_grid(vars(trait), scales = "free") + theme_bw() + scale_x_discrete(expand = c(0,0.3)) + 
  theme(legend.position="none") + 
theme(panel.grid.major=element_blank(),panel.grid.minor=element_blank())+
scale_fill_manual(values=c("Blue", "grey", "pink", "red")) 
```


```{r}

history(Inf)

```




